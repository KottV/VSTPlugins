<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="" >

<head>
<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<title>vst3_dev</title>
<style>
code { white-space: pre-wrap; }
span.smallcaps { font-variant: small-caps; }
span.underline { text-decoration: underline; }
div.column { display: inline-block; vertical-align: top; width: 50%; }
</style>
<style>
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<link rel="stylesheet" href="../style.css" />
</head>

<body>
<details>
<summary translate="yes">Table of Contents</summary>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#vst3-の開発">VST3 の開発</a><ul>
<li><a href="#ライセンス">ライセンス</a></li>
<li><a href="#リソース">リソース</a></li>
<li><a href="#プラグインホストについて">プラグインホストについて</a><ul>
<li><a href="#fl-studio-20.5-での不具合">FL Studio 20.5 での不具合</a></li>
<li><a href="#reaper-5.980-での不具合">Reaper 5.980 での不具合</a></li>
</ul></li>
<li><a href="#開発環境の構築">開発環境の構築</a><ul>
<li><a href="#開発用ソフトウェアのインストール">開発用ソフトウェアのインストール</a></li>
<li><a href="#ripgrep">ripgrep</a></li>
<li><a href="#ビルド">ビルド</a><ul>
<li><a href="#リリースビルド">リリースビルド</a></li>
<li><a href="#bit-x86-ビルド">32bit (x86) ビルド</a></li>
<li><a href="#デプロイ">デプロイ</a></li>
<li><a href="#サンプルプロジェクトのビルドを無効にする">サンプルプロジェクトのビルドを無効にする</a></li>
<li><a href="#コンパイラオプションの変更">コンパイラオプションの変更</a></li>
</ul></li>
</ul></li>
<li><a href="#vst3-プラグインの大まかな仕組み">VST3 プラグインの大まかな仕組み</a></li>
<li><a href="#デバッグ">デバッグ</a><ul>
<li><a href="#ブレークポイント">ブレークポイント</a></li>
<li><a href="#プリント">プリント</a></li>
</ul></li>
<li><a href="#helloworld-プラグインを何とかする">helloworld プラグインを何とかする</a><ul>
<li><a href="#ファイルの配置の変更">ファイルの配置の変更</a></li>
<li><a href="#名前やfuidの設定">名前やFUIDの設定</a></li>
<li><a href="#音を出す">音を出す</a></li>
<li><a href="#パラメータの追加">パラメータの追加</a><ul>
<li><a href="#vst3-のパラメータ">VST3 のパラメータ</a></li>
<li><a href="#パラメータ用のヘッダとソースの作成">パラメータ用のヘッダとソースの作成</a></li>
</ul></li>
<li><a href="#hello-gui">Hello GUI</a></li>
<li><a href="#リファクタリング">リファクタリング</a></li>
</ul></li>
<li><a href="#gui">GUI</a><ul>
<li><a href="#vst3-inline-ui-editor-を使った-gui-の作成">VST3 inline UI editor を使った GUI の作成</a><ul>
<li><a href="#オプションメニュー-コンボボックス-の追加">オプションメニュー (コンボボックス) の追加</a></li>
<li><a href="#ワークアラウンド">ワークアラウンド</a></li>
<li><a href="#カスタムビューの追加">カスタムビューの追加</a></li>
<li><a href="#パラメータの連動">パラメータの連動</a></li>
</ul></li>
<li><a href="#コードでgui">コードでGUI</a><ul>
<li><a href="#リフレッシュレートの設定">リフレッシュレートの設定</a></li>
<li><a href="#カスタムビューの実装と関連するコントロールの表示の変更">カスタムビューの実装と関連するコントロールの表示の変更</a></li>
<li><a href="#スプラッシュスクリーンの追加">スプラッシュスクリーンの追加</a></li>
<li><a href="#ホストが提供するコンテキストメニューの追加">ホストが提供するコンテキストメニューの追加</a></li>
<li><a href="#コンテキストメニューにズーム機能を追加">コンテキストメニューにズーム機能を追加</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
</details>
<h1 id="vst3-の開発">VST3 の開発</h1>
<p>VST3の開発についてまとめました。使ったバージョンは VST3 SDK 3.6.13 と VSTGUI 4.8 です。</p>
<p>この文章では <code>my_plugins</code> から始まるパスは開発中のプラグイン内のパスを表しています。それ以外のパスは特に断りがないときは <code>VST3_SDK</code> 以下の部分だけを書いています。</p>
<p>最新版の SDK は Steinberg のページからダウンロードできます。</p>
<ul>
<li><a href="https://www.steinberg.net/en/company/developers.html">Developers | Steinberg</a></li>
</ul>
<p>GitHub のリポジトリからクローンすることもできます。</p>
<ul>
<li><a href="https://github.com/steinbergmedia/vst3sdk">GitHub - steinbergmedia/vst3sdk: VST 3 Plug-In SDK</a></li>
</ul>
<h2 id="ライセンス">ライセンス</h2>
<p><code>VST3_SDK</code> 以下の各ディレクトリのライセンスです。</p>
<table>
<thead>
<tr class="header">
<th>ディレクトリ</th>
<th>ライセンス</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>base</td>
<td>BSD 3-Clause License</td>
</tr>
<tr class="even">
<td>cmake</td>
<td>Proprietary Steinberg VST3 License あるいは GPLv3</td>
</tr>
<tr class="odd">
<td>doc</td>
<td>Proprietary Steinberg VST3 License あるいは GPLv3</td>
</tr>
<tr class="even">
<td>pluginterfaces</td>
<td>Proprietary Steinberg VST3 License あるいは GPLv3</td>
</tr>
<tr class="odd">
<td>public.sdk</td>
<td>BSD 3-Clause License</td>
</tr>
<tr class="even">
<td>vstgui4</td>
<td>BSD 3-Clause License</td>
</tr>
</tbody>
</table>
<p>Steinberg にメールを送信して確認したところ、 Proprietary Steinberg VST3 License あるいは GPLv3 のどちらを選択するかに関わらず <code>VST3_License_Agreement.pdf</code> に署名して Steinberg に送信する必要があります。</p>
<p>また、これも選択したライセンスに関わらず VST compatible logo の表示が義務付けられています。 VST compatible logo は <code>doc/artwork</code> に入っています。また VST compatible logo の正しい表示方法が <code>VST3_Usage_Guidelines.pdf</code> に書いてあります。</p>
<p>ソースコードを公開するときは GPLv3 で配布することができます。利用したライブラリのライセンスはバイナリの配布時に同梱する必要があります。ユーザマニュアルやGUIのクレジット画面でも利用したライセンスを参照できるようにすることが推奨されています。</p>
<p>ソースコードを公開しないときは Proprietary Steinberg VST3 License と BSD 3-Clause License に従って配布することになります。 Proprietary Steinberg VST3 License の詳細は <code>VST3_License_Agreement.pdf</code> に書いてあります。</p>
<ul>
<li><a href="https://sdk.steinberg.net/viewtopic.php?f=4&amp;t=286&amp;sid=5da7b39b81a3259e03063b18bce97010">VST 3 SDK Licensing FAQ - sdk.steinberg.net</a></li>
<li><a href="https://www.gnu.org/licenses/gpl-3.0.en.html">The GNU General Public License v3.0 - GNU Project - Free Software Foundation</a></li>
<li><a href="https://opensource.org/licenses/BSD-3-Clause">The 3-Clause BSD License | Open Source Initiative</a></li>
<li><a href="https://opensource.stackexchange.com/questions/7575/bsd-3-clause-where-to-place-license-for-binary-installation">binaries - BSD 3-Clause: where to place license for binary installation? - Open Source Stack Exchange</a></li>
</ul>
<h2 id="リソース">リソース</h2>
<p>VST3 SDK の主な学習リソースは同梱されているサンプルプラグインのコードになります。サンプルプラグインは <code>public.sdk/samples/vst</code> に入っています。とりあえず <code>again</code> と <code>note_expression_synth</code> を押さえておけば何とかなります。</p>
<p>VST3 SDK に付属してくるドキュメンテーションはダウンロードしたディレクトリの <code>doc/index.html</code> から開けます。次のリンクは GitHub でホストされているドキュメンテーションです。</p>
<ul>
<li><a href="https://steinbergmedia.github.io/vst3_doc/">Steinberg Plug-in Interfaces Documentation</a></li>
</ul>
<p>VSTGUI4 のドキュメンテーションが404なので、この文章ではドキュメンテーションを参照するときには <code>VST3_SDK</code> からのパスを書いています。</p>
<p>ドキュメンテーション内をまとめて検索する方法が提供されていません。検索窓からクラスなどを探すときはトップページからのリンク先ごとに検索結果が異なるので注意してください。</p>
<p>開発者フォーラムもあります。</p>
<ul>
<li><a href="https://sdk.steinberg.net/index.php">sdk.steinberg.net - Index page</a></li>
</ul>
<p>外部のリソースとしてはうつぼかずらさんによる<a href="http://vstcpp.wpblog.jp/">C++でVST作り</a>がとても参考になります。</p>
<ul>
<li><a href="http://vstcpp.wpblog.jp/">C++でVST作り</a></li>
</ul>
<h2 id="プラグインホストについて">プラグインホストについて</h2>
<p>VST3 はホストによっては実装が中途半端なようです。 FL Studio 20.5 と Reaper 5.980 で動作確認をしているときにいくつか不具合を見つけたのでまとめておきます。</p>
<h3 id="fl-studio-20.5-での不具合">FL Studio 20.5 での不具合</h3>
<ul>
<li>GUI のない VST3 プラグインは何も表示されない。</li>
<li>VST3 プラグインのウィンドウを開いてから別のウィンドウを選択すると、プラグインのウィンドウが真っ黒になる。</li>
</ul>
<p>あと不具合というより仕様ですが、プラグインの GUI ウィンドウの大きさを変更できないので VST3Editor の UI エディタで編集をするときにワークアラウンドが必要です。</p>
<ul>
<li>TODO ワークアラウンドへの参照。</li>
</ul>
<h3 id="reaper-5.980-での不具合">Reaper 5.980 での不具合</h3>
<ul>
<li>VST3Editor の UI エディタを開こうとするとクラッシュする。</li>
</ul>
<h2 id="開発環境の構築">開発環境の構築</h2>
<p>VST3 SDK を編集してビルドできるように開発環境を構築します。</p>
<p>ここでは Windows 10 で CMake + VS Code + PowerShell を使っています。 Visual Studio の IDE は使っていません。</p>
<h3 id="開発用ソフトウェアのインストール">開発用ソフトウェアのインストール</h3>
<p>次のソフトウェアをインストールします。</p>
<ul>
<li><a href="https://visualstudio.microsoft.com/vs/community/">Visual Studio Community 2019</a></li>
<li><a href="https://cmake.org/">CMake</a></li>
<li><a href="https://code.visualstudio.com/">VS Code</a></li>
</ul>
<p>Visual Studio Community 2019 のインストール時には「C++ によるデスクトップ開発」にチェックが入っていることを確認して、あとはデフォルトにしておきました。</p>
<p>次の VS Code のエクステンションをインストールしました。</p>
<ul>
<li>C/C++ (by Microsoft)</li>
<li>CMake (by twxs)</li>
<li>PowerShell (by Microsoft)</li>
<li>XML (by Red Hat)</li>
<li>Bookmarks (by Alessandro Fragnani)</li>
</ul>
<p>XML と Bookmarks は無くても何とかなります。</p>
<p>XML のプラグインは GUI が記述された uidesc というファイルが XML だったのでフォーマットするためにインストールしました。 Red Hat のプラグインにしたのは要素の属性ごとに改行するフォーマットオプションがあったからです。 <a href="https://jdk.java.net/12/">OpenJDK</a> が必要なのでインストールには手間がかかります。</p>
<p>Bookmarks はパラメータ追加で複数のファイルを行ったり来たりするときに便利です。</p>
<h3 id="ripgrep">ripgrep</h3>
<p>ドキュメンテーションなどの検索ツールとして <a href="https://github.com/BurntSushi/ripgrep">ripgrep</a> をインストールしました。まず <a href="https://www.rust-lang.org/">Rust</a> をインストールしてから PowerShell で次のコマンドを実行します。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb1-1"><a href="#cb1-1"></a>cargo install ripgrep</span></code></pre></div>
<p>検索コマンドの例です。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb2-1"><a href="#cb2-1"></a>rg <span class="st">&quot;How to use cmake&quot;</span></span></code></pre></div>
<p>ファイル名だけを表示するときは <code>-l</code> オプションが使えます。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb3-1"><a href="#cb3-1"></a>rg -l <span class="st">&quot;ParamID&quot;</span></span></code></pre></div>
<p>特定のファイルを除外したいときは glob オプションの <code>-g</code> が使えます。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb4-1"><a href="#cb4-1"></a>rg -g <span class="st">&quot;!*.html&quot;</span> -g <span class="st">&quot;!*.js&quot;</span> <span class="st">&quot;EditController&quot;</span></span></code></pre></div>
<p>今回はこれだけでなんとかなりました。他のオプションは <code>-h</code> で確認できます。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb5-1"><a href="#cb5-1"></a>rg -h</span></code></pre></div>
<h3 id="ビルド">ビルド</h3>
<p><code>doc/vstinterfaces/cmakeUse.html</code> と <code>doc/vstinterfaces/addownplugs.html</code> に CMake でのビルド方法が書いてあります。</p>
<p><code>my_plugins/helloworld</code> にテンプレートが入っているのでコピーして適当に名前を付けることでプロジェクトを作成します。 <code>my_plugins</code> は <code>VST3_SDK</code> の1階層上のディレクトリに入っています。</p>
<p>プロジェクト作成後のディレクトリ構造の例です。関係ないディレクトリは省略しています。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb6-1"><a href="#cb6-1"></a>VST_SDK</span>
<span id="cb6-2"><a href="#cb6-2"></a>+---my_plugins</span>
<span id="cb6-3"><a href="#cb6-3"></a>|   +---helloworld</span>
<span id="cb6-4"><a href="#cb6-4"></a>|   +---helloworld_with_VSTGUI</span>
<span id="cb6-5"><a href="#cb6-5"></a>|   \---SomeFX <span class="co"># 追加したプロジェクト。 my_plugins/helloworld のコピー。</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>\---VST3_SDK</span>
<span id="cb6-7"><a href="#cb6-7"></a>    +---base</span>
<span id="cb6-8"><a href="#cb6-8"></a>    +---bin</span>
<span id="cb6-9"><a href="#cb6-9"></a>    +---cmake</span>
<span id="cb6-10"><a href="#cb6-10"></a>    +---doc</span>
<span id="cb6-11"><a href="#cb6-11"></a>    +---pluginterfaces</span>
<span id="cb6-12"><a href="#cb6-12"></a>    +---public.<span class="fu">sdk</span></span>
<span id="cb6-13"><a href="#cb6-13"></a>    \---vstgui4</span></code></pre></div>
<p><code>my_plugins/CMakeLists.txt</code> に <code>SomeFX</code> を追加します。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">add_subdirectory</span>(helloworld)</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw">add_subdirectory</span>(helloworld_with_VSTGUI)</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="kw">add_subdirectory</span>(SomeFX)</span></code></pre></div>
<p><code>VST3_SDK</code> で次のコマンドを実行します。 cmake のオプションで <code>SMTG_MYPLUGINS_SRC_PATH</code> を指定することでプロジェクトのパスを追加できます。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb8-1"><a href="#cb8-1"></a>mkdir build</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="fu">cd</span> build</span>
<span id="cb8-3"><a href="#cb8-3"></a>cmake -G<span class="st">&quot;Visual Studio 16 2019&quot;</span> -DSMTG_MYPLUGINS_SRC_PATH=<span class="st">&quot;../../my_plugins&quot;</span> ..</span>
<span id="cb8-4"><a href="#cb8-4"></a>cmake --build .</span></code></pre></div>
<p>これでデバッグビルドが始まります。コードを変更したときは <code>build</code> ディレクトリに入って <code>cmake --build .</code> でリビルドできます。</p>
<p>ビルドのコンフィグを変更するときは <code>cmake-gui</code> が使えます。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb9-1"><a href="#cb9-1"></a>cmake-gui <span class="co"># build ディレクトリ内で実行する。</span></span></code></pre></div>
<h4 id="リリースビルド">リリースビルド</h4>
<p><code>--config Release</code> を追加します。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb10-1"><a href="#cb10-1"></a>cmake --build . --config Release</span></code></pre></div>
<h4 id="bit-x86-ビルド">32bit (x86) ビルド</h4>
<p>32bit (x86) でビルドするときは一つ目の cmake のコマンドに <code>-A Win32</code> を追加します。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb11-1"><a href="#cb11-1"></a>mkdir build32 <span class="co"># 64bit 版と同じディレクトリを使わない。</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="fu">cd</span> build32</span>
<span id="cb11-3"><a href="#cb11-3"></a>cmake -G<span class="st">&quot;Visual Studio 16 2019&quot;</span> -A Win32 -DSMTG_MYPLUGINS_SRC_PATH=<span class="st">&quot;../../my_plugins&quot;</span> ..</span>
<span id="cb11-4"><a href="#cb11-4"></a>cmake --build .</span></code></pre></div>
<p>ビルドターゲットを 64bit から 32bit に変更するとビルドに失敗するときがあります。ビルドが失敗するときは <code>build</code> ディレクトリを消して作り直してみてください。</p>
<ul>
<li><a href="https://stackoverflow.com/questions/55708600/whats-the-cmake-generator-for-visual-studio-2019">c++ - What’s the cmake generator for Visual Studio 2019 - Stack Overflow</a></li>
<li><a href="https://cmake.org/cmake/help/v3.15/generator/Visual%20Studio%2016%202019.html">Visual Studio 16 2019 — CMake 3.15.0-rc4 Documentation</a></li>
</ul>
<h4 id="デプロイ">デプロイ</h4>
<p>VST3 プラグインのデバッグビルドは <code>build\VST3\Debug</code> 、リリースビルドは <code>build\VST3\Release</code> に配置されます。ビルドされたプラグインは <code>*.vst3</code> という名前のディレクトリにパッケージされています。</p>
<p>VST3 プラグインは OS ごとにインストールする場所が決まっています。詳細は <code>doc/vstinterfaces/vst3loc.html</code> に書いてあります。</p>
<p>Windows では <code>C:\Program Files\Common Files\VST3</code> に配置すれば使えるようになります。</p>
<p>PowerShell で関数を作って任意のプラグインをコマンド一つでデプロイできるようにします。</p>
<p><code>$PROFILE</code> を開きます。 <code>$PROFILE</code> は bash の <code>.bashrc</code> に相当します。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb12-1"><a href="#cb12-1"></a>code <span class="va">$PROFILE</span> <span class="co"># VS Code で開く。パスの通ったエディタが無いときは notepad が使える。</span></span></code></pre></div>
<p>次のコードを <code>$PROFILE</code> に追加します。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">function</span> cpvst(<span class="va">$name</span>, [<span class="kw">switch</span>] <span class="va">$release</span>) {</span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="va">$target_dir</span> = <span class="kw">if</span> (<span class="va">$release</span>) { <span class="st">&quot;Release&quot;</span> } <span class="kw">else</span> { <span class="st">&quot;Debug&quot;</span> }</span>
<span id="cb13-3"><a href="#cb13-3"></a>  <span class="va">$vst_path</span> = <span class="st">&quot;.\VST3\$target_dir\$name.vst3&quot;</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>  attrib.<span class="fu">exe</span> -S <span class="va">$vst_path</span> /D <span class="co"># FL Studio 20.5 にプラグインを読み込ませるために必要。</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="fu">Copy-Item</span> <span class="va">$vst_path</span> -Destination <span class="st">&quot;C:\Program Files\Common Files\VST3&quot;</span> -Force -Recurse</span>
<span id="cb13-6"><a href="#cb13-6"></a>}</span></code></pre></div>
<p><code>$PROFILE</code> を読み込んで更新します。 bash の <code>source</code> と同じような操作です。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb14-1"><a href="#cb14-1"></a>.<span class="va">$PROFILE</span></span></code></pre></div>
<p><code>C:\Program Files\Common Files\VST3</code> にファイルをコピーするには管理者権限が必要ですが、手間を省くために開発を行っているユーザに書き込み権限を与えます。エクスプローラーで <code>VST3</code> を右クリックしてプロパティを開きます。タブからセキュリティを選んで「アクセス許可を変更するには[編集]をクリックします。」というテキストの横にある編集ボタンをクリックします。上のほうにあるグループ名またはユーザ名のリストから開発を行っているユーザを選択します。私の環境では Users (DESKTOP-****) のような名前がついていました。ユーザを選択したら下のほうにあるアクセス許可のリストの書き込みにチェックを入れて OK で <code>VST3</code> への書き込みができるようになります。</p>
<p>これで <code>cpvst</code> が使えるようになりました。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb15-1"><a href="#cb15-1"></a>cpvst helloworld      <span class="co"># build/VST3/Debug/helloworld.vst3 をデプロイ。</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>cpvst SomeFX -release <span class="co"># build/VST3/Release/SomeFX.vst3 をデプロイ。</span></span></code></pre></div>
<h4 id="サンプルプロジェクトのビルドを無効にする">サンプルプロジェクトのビルドを無効にする</h4>
<p>サンプルプロジェクトのビルドを無効にするときは <code>SMTG_ADD_VST3_HOSTING_SAMPLES</code> と <code>SMTG_ADD_VST3_PLUGINS_SAMPLES</code> に <code>FALSE</code> を指定します。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># ` (backtick) は powershell で次の行に続くという意味。 bash の \ と同じ。</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>cmake -G<span class="st">&quot;Visual Studio 16 2019&quot;</span> `</span>
<span id="cb16-3"><a href="#cb16-3"></a>  -DSMTG_MYPLUGINS_SRC_PATH=<span class="st">&quot;../../Plugins&quot;</span> `</span>
<span id="cb16-4"><a href="#cb16-4"></a>  -DSMTG_ADD_VST3_HOSTING_SAMPLES=FALSE `</span>
<span id="cb16-5"><a href="#cb16-5"></a>  -DSMTG_ADD_VST3_PLUGINS_SAMPLES=FALSE `</span>
<span id="cb16-6"><a href="#cb16-6"></a>  ..</span></code></pre></div>
<h4 id="コンパイラオプションの変更">コンパイラオプションの変更</h4>
<p><code>cmake/modules/PlatformToolset.cmake</code> でコンパイラオプションを指定できます。</p>
<h2 id="vst3-プラグインの大まかな仕組み">VST3 プラグインの大まかな仕組み</h2>
<p>VST3 プラグインは大きく次の3つの部品に分けることができます。</p>
<ul>
<li>Edit Controller (コントローラ)</li>
<li>Processor (プロセッサ)</li>
<li>Editor View (エディタ)</li>
</ul>
<p>コントローラはパラメータとユーザインタフェースの橋渡し役です。</p>
<p>プロセッサでは信号処理を行います。</p>
<p>コントローラからプロセッサ、あるいはプロセッサからコントローラへとパラメータを直接を伝えることはありません。コントローラとプロセッサの間でのパラメータの伝達は、DAWなどの VST3 ホストの仕事です。</p>
<p>エディタでは GUI に関する処理を行います。エディタはコントローラの下にぶら下がるような関係になっています。</p>
<p><img src="img/VST3_overview.png" width="320"></p>
<p>コントローラとプロセッサをファクトリに登録することで VST3 プラグインが使えるようになります。ファクトリのコードはテンプレートが用意されているのでほとんど書くことはありません。</p>
<h2 id="デバッグ">デバッグ</h2>
<ul>
<li>TODO: テスト</li>
</ul>
<p>ここに書いてある内容は動作確認していないので間違いがあるかもしれません。 noteexpressionsynth のコードから辿って見つけました。</p>
<h3 id="ブレークポイント">ブレークポイント</h3>
<p><code>FDebugBreak</code> が使えます。</p>
<p><code>FDebugPrint</code> の引数は <code>printf</code> と同じです。</p>
<ul>
<li>未検証: Windows では <code>build/WIN_PDB64</code> に入っている <code>プラグイン名.pdb</code> ファイルを <code>build/VST3/Debug/プラグイン名.vst3/Contents/x86_64-win</code> にコピーしておけば、 <code>FDebugBreak</code> が呼ばれたときにデバッガが起動するはず。</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1"></a><span class="pp">#include </span><span class="im">&quot;base/source/fdebug.h&quot;</span></span>
<span id="cb17-2"><a href="#cb17-2"></a></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="co">// ...</span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="dt">void</span> somewhere(<span class="dt">float</span> value)</span>
<span id="cb17-5"><a href="#cb17-5"></a>{</span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="pp">#if DEVELOPMENT </span><span class="co">// 必ず DEVELOPMENT で囲むこと。</span></span>
<span id="cb17-7"><a href="#cb17-7"></a>  FDebugBreak(<span class="st">&quot;Start debugging at somewhere.</span><span class="sc">\n</span><span class="st">&quot;</span>);</span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="pp">#endif</span></span>
<span id="cb17-9"><a href="#cb17-9"></a>}</span>
<span id="cb17-10"><a href="#cb17-10"></a><span class="co">// ...</span></span></code></pre></div>
<ul>
<li><a href="https://docs.microsoft.com/en-us/visualstudio/debugger/specify-symbol-dot-pdb-and-source-files-in-the-visual-studio-debugger?view=vs-2019">Set symbol (.pdb) and source files in the debugger - Visual Studio | Microsoft Docs</a></li>
</ul>
<h3 id="プリント">プリント</h3>
<p><code>FDebugPrint</code> が使えます。</p>
<p>出力を見るには DAW がデバッグ出力をサポートしている必要があります。 FL Studio 20.5 では左上のメニューから OPTIONS -&gt; Debugging log でデバッグ出力を表示できます。</p>
<p><code>FDebugPrint</code> の引数は <code>printf</code> と同じです。</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1"></a><span class="pp">#include </span><span class="im">&quot;base/source/fdebug.h&quot;</span></span>
<span id="cb18-2"><a href="#cb18-2"></a></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="co">// ...</span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="dt">void</span> somewhere(<span class="dt">float</span> value)</span>
<span id="cb18-5"><a href="#cb18-5"></a>{</span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="pp">#if DEVELOPMENT </span><span class="co">// 必ず DEVELOPMENT で囲むこと。</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>  FDebugPrint(<span class="st">&quot;somewhere, value: </span><span class="sc">%g\n</span><span class="st">&quot;</span>, value);</span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="pp">#endif</span></span>
<span id="cb18-9"><a href="#cb18-9"></a>}</span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="co">// ...</span></span></code></pre></div>
<p><code>base/source/fdebug.h</code> のコメントによると <code>FDebugPrint</code> を直接使わずに、 <code>FDebugPrint</code> をラップしたマクロを使うことが推奨されています。</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1"></a><span class="co">// base/source/fdebug.h</span></span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="co">/** Send &quot;comment&quot; string to the debugger for display. */</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="pp">#define SMTG_WARNING</span>(comment)<span class="pp"> </span>FDebugPrint<span class="pp"> </span>(<span class="st">&quot;</span><span class="sc">%s</span><span class="st">(</span><span class="sc">%d</span><span class="st">) : </span><span class="sc">%s\n</span><span class="st">&quot;</span>,<span class="pp"> </span><span class="ot">__FILE__</span>,<span class="pp"> </span><span class="ot">__LINE__</span>,<span class="pp"> </span>comment);</span>
<span id="cb19-5"><a href="#cb19-5"></a></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="co">/** </span><span class="an">@name</span><span class="co"> </span><span class="do">Shortcut</span><span class="co"> </span><span class="do">macros</span><span class="co"> </span><span class="do">for</span><span class="co"> </span><span class="do">sending</span><span class="co"> </span><span class="do">strings</span><span class="co"> </span><span class="do">to</span><span class="co"> </span><span class="do">the</span><span class="co"> </span><span class="do">debugger</span><span class="co"> </span><span class="do">for</span><span class="co"> </span><span class="do">display.</span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="co">    First parameter is always the format string (printf like).</span></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="co">*/</span></span>
<span id="cb19-9"><a href="#cb19-9"></a></span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="co">///</span><span class="an">@{</span></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="pp">#define SMTG_DBPRT0</span>(a)<span class="pp"> </span>FDebugPrint<span class="pp"> </span>(a);</span>
<span id="cb19-12"><a href="#cb19-12"></a><span class="pp">#define SMTG_DBPRT1</span>(a,<span class="pp"> </span>b)<span class="pp"> </span>FDebugPrint<span class="pp"> </span>(a,<span class="pp"> </span>b);</span>
<span id="cb19-13"><a href="#cb19-13"></a><span class="pp">#define SMTG_DBPRT2</span>(a,<span class="pp"> </span>b,<span class="pp"> </span>c)<span class="pp"> </span>FDebugPrint<span class="pp"> </span>(a,<span class="pp"> </span>b,<span class="pp"> </span>c);</span>
<span id="cb19-14"><a href="#cb19-14"></a><span class="pp">#define SMTG_DBPRT3</span>(a,<span class="pp"> </span>b,<span class="pp"> </span>c,<span class="pp"> </span>d)<span class="pp"> </span>FDebugPrint<span class="pp"> </span>(a,<span class="pp"> </span>b,<span class="pp"> </span>c,<span class="pp"> </span>d);</span>
<span id="cb19-15"><a href="#cb19-15"></a><span class="pp">#define SMTG_DBPRT4</span>(a,<span class="pp"> </span>b,<span class="pp"> </span>c,<span class="pp"> </span>d,<span class="pp"> </span>e)<span class="pp"> </span>FDebugPrint<span class="pp"> </span>(a,<span class="pp"> </span>b,<span class="pp"> </span>c,<span class="pp"> </span>d,<span class="pp"> </span>e);</span>
<span id="cb19-16"><a href="#cb19-16"></a><span class="pp">#define SMTG_DBPRT5</span>(a,<span class="pp"> </span>b,<span class="pp"> </span>c,<span class="pp"> </span>d,<span class="pp"> </span>e,<span class="pp"> </span>f)<span class="pp"> </span>FDebugPrint<span class="pp"> </span>(a,<span class="pp"> </span>b,<span class="pp"> </span>c,<span class="pp"> </span>d,<span class="pp"> </span>e,<span class="pp"> </span>f);</span>
<span id="cb19-17"><a href="#cb19-17"></a><span class="co">///</span><span class="an">@}</span></span></code></pre></div>
<ul>
<li><code>base/source/fdebug.h</code></li>
<li><a href="https://en.cppreference.com/w/cpp/utility/variadic">Variadic functions - cppreference.com</a></li>
</ul>
<h2 id="helloworld-プラグインを何とかする">helloworld プラグインを何とかする</h2>
<p>テンプレートとして用意されている <code>my_plugins/helloworld</code> をリファクタリングしつつ、パラメータ追加のワークフローを作っていきます。</p>
<p>ビルドの節で <code>my_plugins/helloworld</code> をコピーして作成した <code>my_plugins/SomeFX</code> に変更を加えていきます。 <code>my_plugins/SomeFX/**</code> に該当するパスは <code>my_plugins</code> を省略して <code>SomeFX/**</code> のように書いています。</p>
<h3 id="ファイルの配置の変更">ファイルの配置の変更</h3>
<p>コードが書いてあるファイルが7個しかないので、ディレクトリ移動の煩雑さを減らすために一つのディレクトリにまとめてしまいます。</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb20-1"><a href="#cb20-1"></a>+---CMakeLists.<span class="fu">txt</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>+---resource</span>
<span id="cb20-3"><a href="#cb20-3"></a>|   +---Info.<span class="fu">plist</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>|   \---plug.<span class="fu">rc</span></span>
<span id="cb20-5"><a href="#cb20-5"></a>\---source</span>
<span id="cb20-6"><a href="#cb20-6"></a>    +---plugcontroller.<span class="fu">cpp</span></span>
<span id="cb20-7"><a href="#cb20-7"></a>    +---plugcontroller.<span class="fu">hpp</span></span>
<span id="cb20-8"><a href="#cb20-8"></a>    +---plugfactory.<span class="fu">cpp</span></span>
<span id="cb20-9"><a href="#cb20-9"></a>    +---plugids.<span class="fu">hpp</span></span>
<span id="cb20-10"><a href="#cb20-10"></a>    +---plugprocessor.<span class="fu">cpp</span></span>
<span id="cb20-11"><a href="#cb20-11"></a>    +---plugprocessor.<span class="fu">hpp</span></span>
<span id="cb20-12"><a href="#cb20-12"></a>    \---version.<span class="fu">hpp</span></span></code></pre></div>
<p>ここではヘッダの拡張子に “.hpp” を使っています。</p>
<p><code>SomeFX/CMakeList.txt</code> を変更します。</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">set</span>(plug_sources</span>
<span id="cb21-2"><a href="#cb21-2"></a>    source/plugcontroller.hpp</span>
<span id="cb21-3"><a href="#cb21-3"></a>    source/plugids.hpp</span>
<span id="cb21-4"><a href="#cb21-4"></a>    source/plugprocessor.hpp</span>
<span id="cb21-5"><a href="#cb21-5"></a>    source/version.hpp</span>
<span id="cb21-6"><a href="#cb21-6"></a>    source/plugfactory.cpp</span>
<span id="cb21-7"><a href="#cb21-7"></a>    source/plugcontroller.cpp</span>
<span id="cb21-8"><a href="#cb21-8"></a>    source/plugprocessor.cpp</span>
<span id="cb21-9"><a href="#cb21-9"></a>)</span></code></pre></div>
<p><code>SomeFX/resource/plug.rc</code> の <code>version.h</code> のインクルードパスを <code>version.hpp</code> に変更します。</p>
<pre><code>#include &quot;../source/version.hpp&quot;</code></pre>
<h3 id="名前やfuidの設定">名前やFUIDの設定</h3>
<p>この項の内容は <code>doc/vstinterfaces/addownplugs.html</code> に書いてあることと同じなので、あわせて参照することをお勧めします。</p>
<p><code>SomeFX/CMakeLists.txt</code> を変更します。</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span id="cb23-1"><a href="#cb23-1"></a><span class="kw">set</span>(target SomeFX)</span></code></pre></div>
<p><code>SomeFX/source/plugids.hpp</code> にある 2 つの <code>FUID</code> を変更します。コメントにあるように <a href="https://www.guidgenerator.com/">Online GUID Generator</a> を使って生成できます。</p>
<p>次のコードの ID をコピーして使わないでください。 ID が競合すると DAW で予期しないプラグインがロードされる不具合につながります。</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb24-1"><a href="#cb24-1"></a><span class="at">static</span> <span class="at">const</span> FUID MyProcessorUID(<span class="bn">0x00000000</span>, <span class="bn">0x00000000</span>, <span class="bn">0x00000000</span>, <span class="bn">0x00000000</span>);</span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="at">static</span> <span class="at">const</span> FUID MyControllerUID(<span class="bn">0x11111111</span>, <span class="bn">0x11111111</span>, <span class="bn">0x11111111</span>, <span class="bn">0x11111111</span>);</span></code></pre></div>
<p>プラグインの名前などは <code>SomeFX/source/version.hpp</code> で変更できます。</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1"></a><span class="pp">#define stringPluginName </span><span class="st">&quot;Hello World&quot;</span></span>
<span id="cb25-2"><a href="#cb25-2"></a></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="pp">#define stringOriginalFilename </span><span class="st">&quot;SomeFX.vst3&quot;</span></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="pp">#if SMTG_PLATFORM_64</span></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="pp">#define stringFileDescription </span>stringPluginName<span class="pp"> </span><span class="st">&quot; VST3-SDK (64Bit)&quot;</span></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="pp">#else</span></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="pp">#define stringFileDescription </span>stringPluginName<span class="pp"> </span><span class="st">&quot; VST3-SDK&quot;</span></span>
<span id="cb25-8"><a href="#cb25-8"></a><span class="pp">#endif</span></span>
<span id="cb25-9"><a href="#cb25-9"></a><span class="pp">#define stringCompanyName </span><span class="st">&quot;Some Company</span><span class="sc">\0</span><span class="st">&quot;</span></span>
<span id="cb25-10"><a href="#cb25-10"></a><span class="pp">#define stringCompanyWeb </span><span class="st">&quot;https://example.com&quot;</span></span>
<span id="cb25-11"><a href="#cb25-11"></a><span class="pp">#define stringCompanyEmail </span><span class="st">&quot;mailto:someaddress@example.com&quot;</span></span>
<span id="cb25-12"><a href="#cb25-12"></a></span>
<span id="cb25-13"><a href="#cb25-13"></a><span class="pp">#define stringLegalCopyright </span><span class="st">&quot;(c) 2019 Someone&quot;</span></span>
<span id="cb25-14"><a href="#cb25-14"></a><span class="pp">#define stringLegalTrademarks </span><span class="st">&quot;VST is a trademark of Steinberg Media Technologies GmbH&quot;</span></span></code></pre></div>
<p>プラグインの名前を変えるときは <code>Info.plist</code> の <code>SomeFX</code> の部分を変更します。</p>
<ul>
<li>10行目: <code>&lt;string&gt;SomeFX&lt;/string&gt;</code></li>
<li>14行目: <code>&lt;string&gt;com.steinberg.vst3.SomeFX&lt;/string&gt;</code></li>
</ul>
<p>あとは各ファイルで定義されている名前空間 <code>HelloWorld</code> を適当に変更します。</p>
<h3 id="音を出す">音を出す</h3>
<p><code>SomeFX</code> を変更して音が出るようにします。</p>
<p><code>SomeFX/source/plugprocessor.cpp</code> の <code>PlugProcessor::process</code> で音のデータをバッファに書き込みます。</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb26-1"><a href="#cb26-1"></a><span class="co">//--- Process Audio---------------------</span></span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="co">//--- ----------------------------------</span></span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="cf">if</span> (data.numInputs == <span class="dv">0</span>) <span class="cf">return</span> kResultOk;</span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="cf">if</span> (data.numOutputs == <span class="dv">0</span>) <span class="cf">return</span> kResultOk;</span>
<span id="cb26-5"><a href="#cb26-5"></a><span class="cf">if</span> (data.numSamples &lt;= <span class="dv">0</span>) <span class="cf">return</span> kResultOk;</span>
<span id="cb26-6"><a href="#cb26-6"></a></span>
<span id="cb26-7"><a href="#cb26-7"></a><span class="co">// double は処理しない。</span></span>
<span id="cb26-8"><a href="#cb26-8"></a><span class="cf">if</span> (data.symbolicSampleSize == Vst::kSample64) <span class="cf">return</span> kResultOk;</span>
<span id="cb26-9"><a href="#cb26-9"></a></span>
<span id="cb26-10"><a href="#cb26-10"></a><span class="co">// この条件を追加しないと out of bounds へのアクセスでクラッシュする。</span></span>
<span id="cb26-11"><a href="#cb26-11"></a><span class="cf">if</span> (data.inputs[<span class="dv">0</span>].numChannels != <span class="dv">2</span>) <span class="cf">return</span> kResultOk;</span>
<span id="cb26-12"><a href="#cb26-12"></a><span class="cf">if</span> (data.outputs[<span class="dv">0</span>].numChannels != <span class="dv">2</span>) <span class="cf">return</span> kResultOk;</span>
<span id="cb26-13"><a href="#cb26-13"></a></span>
<span id="cb26-14"><a href="#cb26-14"></a><span class="dt">float</span> *in0 = data.inputs[<span class="dv">0</span>].channelBuffers32[<span class="dv">0</span>];</span>
<span id="cb26-15"><a href="#cb26-15"></a><span class="dt">float</span> *in1 = data.inputs[<span class="dv">0</span>].channelBuffers32[<span class="dv">1</span>];</span>
<span id="cb26-16"><a href="#cb26-16"></a><span class="dt">float</span> *out0 = data.outputs[<span class="dv">0</span>].channelBuffers32[<span class="dv">0</span>];</span>
<span id="cb26-17"><a href="#cb26-17"></a><span class="dt">float</span> *out1 = data.outputs[<span class="dv">0</span>].channelBuffers32[<span class="dv">1</span>];</span>
<span id="cb26-18"><a href="#cb26-18"></a></span>
<span id="cb26-19"><a href="#cb26-19"></a><span class="co">// バイパス。</span></span>
<span id="cb26-20"><a href="#cb26-20"></a><span class="cf">for</span> (<span class="dt">int32_t</span> i = <span class="dv">0</span>; i &lt; data.numSamples; ++i) {</span>
<span id="cb26-21"><a href="#cb26-21"></a>  out0[i] = in0[i];</span>
<span id="cb26-22"><a href="#cb26-22"></a>  out1[i] = in1[i];</span>
<span id="cb26-23"><a href="#cb26-23"></a>}</span></code></pre></div>
<p>このコードは入力と出力のチャンネル数が同じであることを仮定しています。入出力のチャンネル数は <code>PlugProcessor::initialize</code> で指定できます。</p>
<p><code>kResultOk</code> は 0 で <code>kResultFalse</code> は 1 なので if の条件で出てくるときは注意してください。 VST3 SDK では <code>if (isIt() == kResultFalse) doIt();</code> のように <code>==</code> でチェックしている箇所があります。</p>
<h3 id="パラメータの追加">パラメータの追加</h3>
<p>このままだとパラメータの管理が手間になるのでリファクタリングします。</p>
<h4 id="vst3-のパラメータ">VST3 のパラメータ</h4>
<p>VST3 では1つのパラメータをコントローラとプロセッサの2か所で保持させることになります。</p>
<ul>
<li>TODO 図の追加</li>
</ul>
<h4 id="パラメータ用のヘッダとソースの作成">パラメータ用のヘッダとソースの作成</h4>
<p>TODO 変更</p>
<ul>
<li><code>SomeFX/source/plugid.hpp</code></li>
<li><code>SomeFX/source/plugcontroller.cpp</code></li>
<li><code>SomeFX/source/plugprocessor.hpp</code></li>
<li><code>SomeFX/source/plugprocessor.cpp</code></li>
</ul>
<h3 id="hello-gui">Hello GUI</h3>
<p>VSTGUI 4.8 ではコードで直接 GUI を書く方法と、 VST3 inline UI editor を使って GUI を作る方法があります。ここでは VST3 inline UI editor という名前を短くして UI エディタと呼ぶことにします。</p>
<p>本格的な開発をするならコードで直接 GUI を書く方法をお勧めします。私が試した限りでは FL Studio 20.5 と Reaper 5.980 では UI エディタを使う方法に不具合がありました。不具合については GUI -&gt; VST3 inline UI editor を使った GUI の作成 -&gt; ワークアラウンド にまとめています。</p>
<p>ここでは例として手軽でコードが少ない UI エディタを使う方法で GUI を作ります。</p>
<p><code>SomeFX/source/plugcontroller.hpp</code> を変更します。</p>
<ul>
<li><code>vst3editor.h</code> をインクルード。</li>
<li><code>createView</code> を追加。</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb27-1"><a href="#cb27-1"></a><span class="pp">#include </span><span class="im">&quot;vstgui/plugin-bindings/vst3editor.h&quot;</span></span>
<span id="cb27-2"><a href="#cb27-2"></a></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="kw">class</span> PlugController : <span class="kw">public</span> Vst::EditController {</span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="kw">public</span>:</span>
<span id="cb27-5"><a href="#cb27-5"></a></span>
<span id="cb27-6"><a href="#cb27-6"></a>  <span class="co">// ...</span></span>
<span id="cb27-7"><a href="#cb27-7"></a></span>
<span id="cb27-8"><a href="#cb27-8"></a>  IPlugView *PLUGIN_API createView(<span class="at">const</span> <span class="dt">char</span> *name) SMTG_OVERRIDE</span>
<span id="cb27-9"><a href="#cb27-9"></a>  {</span>
<span id="cb27-10"><a href="#cb27-10"></a>    <span class="cf">if</span> (name &amp;&amp; strcmp(name, <span class="st">&quot;editor&quot;</span>) == <span class="dv">0</span>)</span>
<span id="cb27-11"><a href="#cb27-11"></a>      <span class="cf">return</span> <span class="kw">new</span> VSTGUI::VST3Editor(<span class="kw">this</span>, <span class="st">&quot;view&quot;</span>, <span class="st">&quot;plug.uidesc&quot;</span>);</span>
<span id="cb27-12"><a href="#cb27-12"></a>    <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb27-13"><a href="#cb27-13"></a>  }</span>
<span id="cb27-14"><a href="#cb27-14"></a>};</span></code></pre></div>
<p><code>SomeFX/CMakeLists.txt</code> を変更します。</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># ...</span></span>
<span id="cb28-2"><a href="#cb28-2"></a></span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="fu">smtg_add_vst3plugin</span>(<span class="dv">${</span>target<span class="dv">}</span> <span class="dv">${</span>plug_sources<span class="dv">}</span>)</span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="kw">set</span>_target_properties(<span class="dv">${</span>target<span class="dv">}</span> PROPERTIES <span class="dv">${</span>SDK_IDE_MYPLUGINS_FOLDER<span class="dv">}</span>)</span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="kw">target_include_directories</span>(<span class="dv">${</span>target<span class="dv">}</span> <span class="ot">PUBLIC</span> <span class="dv">${VSTGUI_ROOT}</span>/vstgui4) <span class="co"># 追加。</span></span>
<span id="cb28-6"><a href="#cb28-6"></a><span class="kw">target_link_libraries</span>(<span class="dv">${</span>target<span class="dv">}</span> <span class="ot">PRIVATE</span> base sdk vstgui_support)    <span class="co"># vstgui_support を追加。</span></span>
<span id="cb28-7"><a href="#cb28-7"></a></span>
<span id="cb28-8"><a href="#cb28-8"></a><span class="co"># ...</span></span></code></pre></div>
<p>ビルドしたプラグインを開くと真っ黒の画面が表示されます。黒い部分を右クリックするとコンテクストメニューが開いて UI エディタでの編集が選択できます。</p>
<p>UI エディタの使い方は <code>vstgui4/vstgui/Documentation/html/page_uidescription_editor.html</code> に書いてあります。</p>
<ul>
<li>TODO 画像</li>
<li>TODO tag の設定。</li>
</ul>
<p>UI エディタでの編集が終わったらの左上にあるメニューから File -&gt; Save As を選んで <code>plug.uidesc</code> を保存します。保存した <code>plug.uidesc</code> を適当なディレクトリにおいて <code>SomeFX/CMakeLists.txt</code> の <code>smtg_add_vst3_resource</code> でパスを指定することでリソースに追加できます。</p>
<pre><code># ...
target_link_libraries(${target} PRIVATE base sdk vstgui_support) # 上で変更した行。

# リソースの追加。
# 初回作成時など UI エディタで作った uidesc ファイルがないときはコメントアウトしておく。
smtg_add_vst3_resource(${target} &quot;resource/plug.uidesc&quot;)

# ...</code></pre>
<p>画像ファイルを使うときも <code>smtg_add_vst3_resource</code> でリソースに追加できます。</p>
<h3 id="リファクタリング">リファクタリング</h3>
<ul>
<li>TODO</li>
</ul>
<h2 id="gui">GUI</h2>
<p>主にカスタムビューの作成についてまとめています。</p>
<h3 id="vst3-inline-ui-editor-を使った-gui-の作成">VST3 inline UI editor を使った GUI の作成</h3>
<h4 id="オプションメニュー-コンボボックス-の追加">オプションメニュー (コンボボックス) の追加</h4>
<p>オプションメニューのアイテムは <code>StringListParameter</code> を使うことで設定できます。</p>
<p>オプションメニューとリンクするパラメータを <code>SomeFX/source/plugcontroller.cpp</code> の <code>initialize</code> に追加します。</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb30-1"><a href="#cb30-1"></a><span class="pp">#include </span><span class="im">&quot;public.sdk/source/vst/vstparameters.h&quot;</span></span>
<span id="cb30-2"><a href="#cb30-2"></a></span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="co">// ...</span></span>
<span id="cb30-4"><a href="#cb30-4"></a></span>
<span id="cb30-5"><a href="#cb30-5"></a>tresult PLUGIN_API PlugController::initialize(FUnknown *context)</span>
<span id="cb30-6"><a href="#cb30-6"></a>{</span>
<span id="cb30-7"><a href="#cb30-7"></a>  <span class="co">// ...</span></span>
<span id="cb30-8"><a href="#cb30-8"></a></span>
<span id="cb30-9"><a href="#cb30-9"></a>  <span class="kw">auto</span> parameterType = <span class="kw">new</span> Vst::StringListParameter(USTRING(<span class="st">&quot;Type&quot;</span>), ParameterID::type);</span>
<span id="cb30-10"><a href="#cb30-10"></a>  parameterType-&gt;appendString(USTRING(<span class="st">&quot;uhhyou&quot;</span>));</span>
<span id="cb30-11"><a href="#cb30-11"></a>  parameterType-&gt;appendString(USTRING(<span class="st">&quot;yey&quot;</span>));</span>
<span id="cb30-12"><a href="#cb30-12"></a>  parameters.addParameter(parameterType);</span>
<span id="cb30-13"><a href="#cb30-13"></a>}</span></code></pre></div>
<p>あとは UI エディタで <code>StringListParameter</code> として追加したパラメータのIDをオプションメニューの control-tag として指定すれば設定完了です。</p>
<ul>
<li><code>public.sdk/samples/vst/note_expression_synth/source/note_expression_synth_controller.cpp</code></li>
<li><code>public.sdk/source/vst/vstparameters.*</code></li>
</ul>
<h4 id="ワークアラウンド">ワークアラウンド</h4>
<p>FL Studio 20.5 ではプラグインのウィンドウの大きさを変更できないので編集が困難です。ワークアラウンドとして <code>plug.uidesc</code> を直接編集して編集画面の大きさを変更することができます。</p>
<p>いったん UI エディタを開いて何も編集せずにメニューの Save as で <code>plug.uidesc</code> を保存します。 <code>plug.uidesc</code> をテキストエディタで開いて custom -&gt; attributes -&gt; EditorSize を変更することでGUI エディタのウィンドウの大きさを設定できます。 EditorSize のフォーマットは <code>"x, y, width, height"</code> となっています。変更した <code>plug.uidesc</code> をリソースとしてプラグインに追加すると次回から UI エディタのウィンドウが設定した大きさになります。</p>
<p>Reaper v5.980 では UI エディタを開こうとするとクラッシュするので使えません。</p>
<h4 id="カスタムビューの追加">カスタムビューの追加</h4>
<p>カスタムビューの概要については コードでGUI -&gt; カスタムビューの実装と関連するコントロールの表示の変更 を参照してください。</p>
<p>サイン波を表示するカスタムビューを作ります。</p>
<p>次の3つのファイルを作成します。</p>
<ul>
<li><code>SomeFX/source/gui/waveview.hpp</code></li>
<li><code>SomeFX/source/gui/waveview.cpp</code></li>
<li><code>SomeFX/source/gui/waveviewcreator.cpp</code></li>
</ul>
<p><code>SomeFX/source/gui/waveview.hpp</code> の内容です。</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb31-1"><a href="#cb31-1"></a><span class="pp">#pragma once</span></span>
<span id="cb31-2"><a href="#cb31-2"></a></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="pp">#include </span><span class="im">&quot;vstgui4/vstgui/vstgui.h&quot;</span></span>
<span id="cb31-4"><a href="#cb31-4"></a></span>
<span id="cb31-5"><a href="#cb31-5"></a><span class="kw">namespace</span> VSTGUI {</span>
<span id="cb31-6"><a href="#cb31-6"></a></span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="kw">class</span> WaveView : <span class="kw">public</span> CControl {</span>
<span id="cb31-8"><a href="#cb31-8"></a><span class="kw">public</span>:</span>
<span id="cb31-9"><a href="#cb31-9"></a>  WaveView(<span class="at">const</span> CRect &amp;size);</span>
<span id="cb31-10"><a href="#cb31-10"></a></span>
<span id="cb31-11"><a href="#cb31-11"></a>  <span class="dt">void</span> draw(CDrawContext *pContext) <span class="kw">override</span>;</span>
<span id="cb31-12"><a href="#cb31-12"></a></span>
<span id="cb31-13"><a href="#cb31-13"></a>  CLASS_METHODS(WaveView, CControl);</span>
<span id="cb31-14"><a href="#cb31-14"></a></span>
<span id="cb31-15"><a href="#cb31-15"></a>  <span class="dt">double</span> lfo(<span class="dt">double</span> phase);</span>
<span id="cb31-16"><a href="#cb31-16"></a></span>
<span id="cb31-17"><a href="#cb31-17"></a>  <span class="dt">double</span> gain = <span class="fl">0.9</span>;</span>
<span id="cb31-18"><a href="#cb31-18"></a>  <span class="dt">double</span> shape = <span class="fl">0.0</span>;</span>
<span id="cb31-19"><a href="#cb31-19"></a>  <span class="dt">double</span> phase = <span class="fl">0.0</span>;</span>
<span id="cb31-20"><a href="#cb31-20"></a></span>
<span id="cb31-21"><a href="#cb31-21"></a><span class="kw">protected</span>:</span>
<span id="cb31-22"><a href="#cb31-22"></a>  CLineStyle lineStyle{CLineStyle::kLineCapRound, CLineStyle::kLineJoinRound};</span>
<span id="cb31-23"><a href="#cb31-23"></a>  CDrawContext::PointList points;</span>
<span id="cb31-24"><a href="#cb31-24"></a>};</span>
<span id="cb31-25"><a href="#cb31-25"></a></span>
<span id="cb31-26"><a href="#cb31-26"></a>} <span class="co">// namespace VSTGUI</span></span></code></pre></div>
<p><code>SomeFX/source/gui/waveview.cpp</code> の内容です。</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb32-1"><a href="#cb32-1"></a><span class="pp">#include </span><span class="im">&quot;waveview.hpp&quot;</span></span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="pp">#include </span><span class="im">&lt;cmath&gt;</span></span>
<span id="cb32-3"><a href="#cb32-3"></a></span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="kw">namespace</span> VSTGUI {</span>
<span id="cb32-5"><a href="#cb32-5"></a></span>
<span id="cb32-6"><a href="#cb32-6"></a>WaveView::WaveView(<span class="at">const</span> CRect &amp;size) : CControl(size) {}</span>
<span id="cb32-7"><a href="#cb32-7"></a></span>
<span id="cb32-8"><a href="#cb32-8"></a><span class="dt">void</span> WaveView::draw(CDrawContext *pContext)</span>
<span id="cb32-9"><a href="#cb32-9"></a>{</span>
<span id="cb32-10"><a href="#cb32-10"></a>  pContext-&gt;setDrawMode(CDrawMode(CDrawModeFlags::kAntiAliasing));</span>
<span id="cb32-11"><a href="#cb32-11"></a>  CDrawContext::Transform t(</span>
<span id="cb32-12"><a href="#cb32-12"></a>    *pContext, CGraphicsTransform().translate(getViewSize().getTopLeft()));</span>
<span id="cb32-13"><a href="#cb32-13"></a></span>
<span id="cb32-14"><a href="#cb32-14"></a>  <span class="at">const</span> <span class="kw">auto</span> width = getWidth();</span>
<span id="cb32-15"><a href="#cb32-15"></a>  <span class="at">const</span> <span class="kw">auto</span> height = getHeight();</span>
<span id="cb32-16"><a href="#cb32-16"></a>  <span class="at">const</span> <span class="dt">double</span> borderWidth = <span class="fl">2.0</span>;</span>
<span id="cb32-17"><a href="#cb32-17"></a>  <span class="at">const</span> <span class="dt">double</span> halfBorderWidth = borderWidth / <span class="fl">2.0</span>;</span>
<span id="cb32-18"><a href="#cb32-18"></a></span>
<span id="cb32-19"><a href="#cb32-19"></a>  <span class="co">// Background.</span></span>
<span id="cb32-20"><a href="#cb32-20"></a>  <span class="at">const</span> <span class="kw">auto</span> bgColor = CColor(<span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>);</span>
<span id="cb32-21"><a href="#cb32-21"></a>  pContext-&gt;setLineWidth(borderWidth);</span>
<span id="cb32-22"><a href="#cb32-22"></a>  pContext-&gt;setFillColor(bgColor);</span>
<span id="cb32-23"><a href="#cb32-23"></a>  pContext-&gt;drawRect(CRect(<span class="fl">0.0</span>, <span class="fl">0.0</span>, width, height), kDrawFilled);</span>
<span id="cb32-24"><a href="#cb32-24"></a></span>
<span id="cb32-25"><a href="#cb32-25"></a>  <span class="co">// Waveform.</span></span>
<span id="cb32-26"><a href="#cb32-26"></a>  pContext-&gt;setLineWidth(<span class="fl">2.0</span>);</span>
<span id="cb32-27"><a href="#cb32-27"></a>  pContext-&gt;setLineStyle(lineStyle);</span>
<span id="cb32-28"><a href="#cb32-28"></a>  pContext-&gt;setFrameColor(CColor(<span class="dv">19</span>, <span class="dv">193</span>, <span class="dv">54</span>, <span class="dv">255</span>));</span>
<span id="cb32-29"><a href="#cb32-29"></a>  <span class="at">const</span> <span class="dt">size_t</span> size = (<span class="dt">size_t</span>)(width + <span class="fl">1.0</span>);</span>
<span id="cb32-30"><a href="#cb32-30"></a>  <span class="cf">if</span> (points.size() != size) points.resize(size);</span>
<span id="cb32-31"><a href="#cb32-31"></a>  <span class="cf">for</span> (<span class="dt">size_t</span> x = <span class="dv">0</span>; x &lt; points.size(); ++x)</span>
<span id="cb32-32"><a href="#cb32-32"></a>    points[x] = CPoint((CCoord)x, height * lfo(x / width));</span>
<span id="cb32-33"><a href="#cb32-33"></a>  pContext-&gt;drawPolygon(points);</span>
<span id="cb32-34"><a href="#cb32-34"></a></span>
<span id="cb32-35"><a href="#cb32-35"></a>  <span class="co">// Always draw border at last. Otherwise, inner object will be drawn over border.</span></span>
<span id="cb32-36"><a href="#cb32-36"></a>  <span class="at">const</span> <span class="kw">auto</span> borderColor = CColor(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">255</span>);</span>
<span id="cb32-37"><a href="#cb32-37"></a>  pContext-&gt;setFrameColor(borderColor);</span>
<span id="cb32-38"><a href="#cb32-38"></a>  pContext-&gt;drawRect(</span>
<span id="cb32-39"><a href="#cb32-39"></a>    CRect(halfBorderWidth, halfBorderWidth, width, height), kDrawStroked);</span>
<span id="cb32-40"><a href="#cb32-40"></a></span>
<span id="cb32-41"><a href="#cb32-41"></a>  setDirty(<span class="kw">false</span>);</span>
<span id="cb32-42"><a href="#cb32-42"></a>}</span>
<span id="cb32-43"><a href="#cb32-43"></a></span>
<span id="cb32-44"><a href="#cb32-44"></a><span class="dt">double</span> WaveView::lfo(<span class="dt">double</span> phase)</span>
<span id="cb32-45"><a href="#cb32-45"></a>{</span>
<span id="cb32-46"><a href="#cb32-46"></a>  <span class="at">const</span> <span class="dt">double</span> twopi = <span class="fl">6.283185307179586</span>;</span>
<span id="cb32-47"><a href="#cb32-47"></a></span>
<span id="cb32-48"><a href="#cb32-48"></a>  phase = <span class="kw">this</span>-&gt;phase + phase * twopi;</span>
<span id="cb32-49"><a href="#cb32-49"></a>  <span class="cf">if</span> (phase &gt; twopi) phase -= twopi;</span>
<span id="cb32-50"><a href="#cb32-50"></a>  <span class="kw">auto</span> sign = (pi &lt; phase) - (phase &lt; pi);</span>
<span id="cb32-51"><a href="#cb32-51"></a>  <span class="kw">auto</span> wave = gain * sign * pow(abs(sin(phase)), shape);</span>
<span id="cb32-52"><a href="#cb32-52"></a>  <span class="cf">return</span> (wave + <span class="fl">1.0</span>) * <span class="fl">0.5</span>;</span>
<span id="cb32-53"><a href="#cb32-53"></a>}</span>
<span id="cb32-54"><a href="#cb32-54"></a></span>
<span id="cb32-55"><a href="#cb32-55"></a>} <span class="co">// namespace VSTGUI</span></span></code></pre></div>
<p><code>SomeFX/source/gui/waveviewcreator.cpp</code> の内容です。</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb33-1"><a href="#cb33-1"></a><span class="pp">#pragma once</span></span>
<span id="cb33-2"><a href="#cb33-2"></a></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="pp">#include </span><span class="im">&quot;waveview.hpp&quot;</span></span>
<span id="cb33-4"><a href="#cb33-4"></a></span>
<span id="cb33-5"><a href="#cb33-5"></a><span class="pp">#include </span><span class="im">&quot;vstgui4/vstgui/uidescription/detail/uiviewcreatorattributes.h&quot;</span></span>
<span id="cb33-6"><a href="#cb33-6"></a><span class="pp">#include </span><span class="im">&quot;vstgui4/vstgui/uidescription/iviewcreator.h&quot;</span></span>
<span id="cb33-7"><a href="#cb33-7"></a><span class="pp">#include </span><span class="im">&quot;vstgui4/vstgui/uidescription/uiattributes.h&quot;</span></span>
<span id="cb33-8"><a href="#cb33-8"></a><span class="pp">#include </span><span class="im">&quot;vstgui4/vstgui/uidescription/uiviewfactory.h&quot;</span></span>
<span id="cb33-9"><a href="#cb33-9"></a><span class="pp">#include </span><span class="im">&quot;vstgui4/vstgui/vstgui.h&quot;</span></span>
<span id="cb33-10"><a href="#cb33-10"></a></span>
<span id="cb33-11"><a href="#cb33-11"></a><span class="kw">namespace</span> VSTGUI {</span>
<span id="cb33-12"><a href="#cb33-12"></a><span class="kw">namespace</span> UIViewCreator {</span>
<span id="cb33-13"><a href="#cb33-13"></a></span>
<span id="cb33-14"><a href="#cb33-14"></a><span class="kw">class</span> WaveViewCreator : <span class="kw">public</span> ViewCreatorAdapter {</span>
<span id="cb33-15"><a href="#cb33-15"></a><span class="kw">public</span>:</span>
<span id="cb33-16"><a href="#cb33-16"></a>  WaveViewCreator()</span>
<span id="cb33-17"><a href="#cb33-17"></a>  {</span>
<span id="cb33-18"><a href="#cb33-18"></a>    UIViewFactory::registerViewCreator(*<span class="kw">this</span>);</span>
<span id="cb33-19"><a href="#cb33-19"></a>  }</span>
<span id="cb33-20"><a href="#cb33-20"></a></span>
<span id="cb33-21"><a href="#cb33-21"></a>  IdStringPtr getViewName() <span class="at">const</span></span>
<span id="cb33-22"><a href="#cb33-22"></a>  {</span>
<span id="cb33-23"><a href="#cb33-23"></a>    <span class="cf">return</span> <span class="st">&quot;WaveView&quot;</span>; <span class="co">// カスタムビューの名前。</span></span>
<span id="cb33-24"><a href="#cb33-24"></a>  }</span>
<span id="cb33-25"><a href="#cb33-25"></a></span>
<span id="cb33-26"><a href="#cb33-26"></a>  IdStringPtr getBaseViewName() <span class="at">const</span></span>
<span id="cb33-27"><a href="#cb33-27"></a>  {</span>
<span id="cb33-28"><a href="#cb33-28"></a>    <span class="cf">return</span> <span class="st">&quot;CControl&quot;</span>; <span class="co">// カスタムビューの親クラスの名前。</span></span>
<span id="cb33-29"><a href="#cb33-29"></a>  }</span>
<span id="cb33-30"><a href="#cb33-30"></a></span>
<span id="cb33-31"><a href="#cb33-31"></a>  CView *create(<span class="at">const</span> UIAttributes &amp;attributes, <span class="at">const</span> IUIDescription *description) <span class="at">const</span></span>
<span id="cb33-32"><a href="#cb33-32"></a>  {</span>
<span id="cb33-33"><a href="#cb33-33"></a>    <span class="co">// UI エディタの右下からドラッグ &amp; ドロップしたときに作成されるインスタンスを設定。</span></span>
<span id="cb33-34"><a href="#cb33-34"></a>    <span class="cf">return</span> <span class="kw">new</span> WaveView(CRect(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">50</span>));</span>
<span id="cb33-35"><a href="#cb33-35"></a>  }</span>
<span id="cb33-36"><a href="#cb33-36"></a></span>
<span id="cb33-37"><a href="#cb33-37"></a>  <span class="dt">bool</span> apply(</span>
<span id="cb33-38"><a href="#cb33-38"></a>    CView *view, <span class="at">const</span> UIAttributes &amp;attributes, <span class="at">const</span> IUIDescription *description) <span class="at">const</span></span>
<span id="cb33-39"><a href="#cb33-39"></a>  {</span>
<span id="cb33-40"><a href="#cb33-40"></a>    <span class="co">// uidesc から読み込んだパラメータを適用。</span></span>
<span id="cb33-41"><a href="#cb33-41"></a>    <span class="co">// ここでは位置、大きさ、 sub-controller だけを設定。</span></span>
<span id="cb33-42"><a href="#cb33-42"></a>    <span class="co">// vstgui4/vstgui/uidescription/uiviewcreator.cpp の CViewCreator からコピーしてきた。</span></span>
<span id="cb33-43"><a href="#cb33-43"></a></span>
<span id="cb33-44"><a href="#cb33-44"></a>    <span class="kw">auto</span> waveView = <span class="kw">dynamic_cast</span>&lt;WaveView *&gt;(view);</span>
<span id="cb33-45"><a href="#cb33-45"></a>    <span class="cf">if</span> (waveView == <span class="dv">0</span>) <span class="cf">return</span> <span class="kw">false</span>;</span>
<span id="cb33-46"><a href="#cb33-46"></a></span>
<span id="cb33-47"><a href="#cb33-47"></a>    CPoint point;</span>
<span id="cb33-48"><a href="#cb33-48"></a>    CRect size;</span>
<span id="cb33-49"><a href="#cb33-49"></a>    <span class="cf">if</span> (attributes.getPointAttribute(kAttrOrigin, point)) {</span>
<span id="cb33-50"><a href="#cb33-50"></a>      <span class="kw">auto</span> viewSize = waveView-&gt;getViewSize();</span>
<span id="cb33-51"><a href="#cb33-51"></a>      size.setTopLeft(point);</span>
<span id="cb33-52"><a href="#cb33-52"></a>      size.setWidth(viewSize.getWidth());</span>
<span id="cb33-53"><a href="#cb33-53"></a>      size.setHeight(viewSize.getHeight());</span>
<span id="cb33-54"><a href="#cb33-54"></a>      waveView-&gt;setViewSize(size, <span class="kw">false</span>);</span>
<span id="cb33-55"><a href="#cb33-55"></a>      waveView-&gt;setMouseableArea(size);</span>
<span id="cb33-56"><a href="#cb33-56"></a>    }</span>
<span id="cb33-57"><a href="#cb33-57"></a>    <span class="cf">if</span> (attributes.getPointAttribute(kAttrSize, point)) {</span>
<span id="cb33-58"><a href="#cb33-58"></a>      size = waveView-&gt;getViewSize();</span>
<span id="cb33-59"><a href="#cb33-59"></a>      size.setSize(point);</span>
<span id="cb33-60"><a href="#cb33-60"></a>      waveView-&gt;setViewSize(size, <span class="kw">false</span>);</span>
<span id="cb33-61"><a href="#cb33-61"></a>      waveView-&gt;setMouseableArea(size);</span>
<span id="cb33-62"><a href="#cb33-62"></a>    }</span>
<span id="cb33-63"><a href="#cb33-63"></a></span>
<span id="cb33-64"><a href="#cb33-64"></a>    <span class="at">const</span> <span class="kw">auto</span> subControllerAttr = attributes.getAttributeValue(kAttrSubController);</span>
<span id="cb33-65"><a href="#cb33-65"></a>    <span class="cf">if</span> (subControllerAttr) {</span>
<span id="cb33-66"><a href="#cb33-66"></a>      view-&gt;setAttribute(</span>
<span id="cb33-67"><a href="#cb33-67"></a>        <span class="ch">&#39;u</span><span class="er">isc</span><span class="ch">&#39;</span>,</span>
<span id="cb33-68"><a href="#cb33-68"></a>        <span class="kw">static_cast</span>&lt;<span class="dt">uint32_t</span>&gt;(subControllerAttr-&gt;size() + <span class="dv">1</span>),</span>
<span id="cb33-69"><a href="#cb33-69"></a>        subControllerAttr-&gt;c_str());</span>
<span id="cb33-70"><a href="#cb33-70"></a>    }</span>
<span id="cb33-71"><a href="#cb33-71"></a></span>
<span id="cb33-72"><a href="#cb33-72"></a>    <span class="cf">return</span> <span class="kw">true</span>;</span>
<span id="cb33-73"><a href="#cb33-73"></a>  }</span>
<span id="cb33-74"><a href="#cb33-74"></a></span>
<span id="cb33-75"><a href="#cb33-75"></a>  <span class="dt">bool</span> getAttributeNames(<span class="bu">std::</span>list&lt;<span class="bu">std::</span>string&gt; &amp;attributeNames) <span class="at">const</span></span>
<span id="cb33-76"><a href="#cb33-76"></a>  {</span>
<span id="cb33-77"><a href="#cb33-77"></a>    <span class="co">// uidesc に書き込まれる属性の名前を設定。</span></span>
<span id="cb33-78"><a href="#cb33-78"></a>    <span class="co">// kAttr* は vstgui4\vstgui\uidescription\detail\uiviewcreatorattributes.h を参照。</span></span>
<span id="cb33-79"><a href="#cb33-79"></a></span>
<span id="cb33-80"><a href="#cb33-80"></a>    attributeNames.emplace_back(kAttrOrigin);</span>
<span id="cb33-81"><a href="#cb33-81"></a>    attributeNames.emplace_back(kAttrSize);</span>
<span id="cb33-82"><a href="#cb33-82"></a>    attributeNames.emplace_back(kAttrSubController);</span>
<span id="cb33-83"><a href="#cb33-83"></a>    <span class="cf">return</span> <span class="kw">true</span>;</span>
<span id="cb33-84"><a href="#cb33-84"></a>  }</span>
<span id="cb33-85"><a href="#cb33-85"></a></span>
<span id="cb33-86"><a href="#cb33-86"></a>  IViewCreator::AttrType getAttributeType(<span class="at">const</span> <span class="bu">std::</span>string &amp;attributeName) <span class="at">const</span></span>
<span id="cb33-87"><a href="#cb33-87"></a>  {</span>
<span id="cb33-88"><a href="#cb33-88"></a>    <span class="co">// uidesc の属性を C++ で受け取るときの型を設定。</span></span>
<span id="cb33-89"><a href="#cb33-89"></a></span>
<span id="cb33-90"><a href="#cb33-90"></a>    <span class="cf">if</span> (attributeName == kAttrOrigin)</span>
<span id="cb33-91"><a href="#cb33-91"></a>      <span class="cf">return</span> kPointType;</span>
<span id="cb33-92"><a href="#cb33-92"></a>    <span class="cf">else</span> <span class="cf">if</span> (attributeName == kAttrSize)</span>
<span id="cb33-93"><a href="#cb33-93"></a>      <span class="cf">return</span> kPointType;</span>
<span id="cb33-94"><a href="#cb33-94"></a>    <span class="cf">else</span> <span class="cf">if</span> (attributeName == kAttrSubController)</span>
<span id="cb33-95"><a href="#cb33-95"></a>      <span class="cf">return</span> kStringType;</span>
<span id="cb33-96"><a href="#cb33-96"></a>    <span class="cf">return</span> kUnknownType;</span>
<span id="cb33-97"><a href="#cb33-97"></a>  }</span>
<span id="cb33-98"><a href="#cb33-98"></a></span>
<span id="cb33-99"><a href="#cb33-99"></a>  <span class="dt">bool</span> getAttributeValue(</span>
<span id="cb33-100"><a href="#cb33-100"></a>    CView *view,</span>
<span id="cb33-101"><a href="#cb33-101"></a>    <span class="at">const</span> <span class="bu">std::</span>string &amp;attributeName,</span>
<span id="cb33-102"><a href="#cb33-102"></a>    <span class="bu">std::</span>string &amp;stringValue,</span>
<span id="cb33-103"><a href="#cb33-103"></a>    <span class="at">const</span> IUIDescription *desc) <span class="at">const</span></span>
<span id="cb33-104"><a href="#cb33-104"></a>  {</span>
<span id="cb33-105"><a href="#cb33-105"></a>    <span class="co">// UI エディタで設定された属性を uidesc に書き込む文字列に変換。</span></span>
<span id="cb33-106"><a href="#cb33-106"></a></span>
<span id="cb33-107"><a href="#cb33-107"></a>    <span class="cf">if</span> (attributeName == kAttrOrigin) {</span>
<span id="cb33-108"><a href="#cb33-108"></a>      stringValue = UIAttributes::pointToString(view-&gt;getViewSize().getTopLeft());</span>
<span id="cb33-109"><a href="#cb33-109"></a>      <span class="cf">return</span> <span class="kw">true</span>;</span>
<span id="cb33-110"><a href="#cb33-110"></a>    } <span class="cf">else</span> <span class="cf">if</span> (attributeName == kAttrSize) {</span>
<span id="cb33-111"><a href="#cb33-111"></a>      stringValue = UIAttributes::pointToString(view-&gt;getViewSize().getSize());</span>
<span id="cb33-112"><a href="#cb33-112"></a>      <span class="cf">return</span> <span class="kw">true</span>;</span>
<span id="cb33-113"><a href="#cb33-113"></a>    } <span class="cf">else</span> <span class="cf">if</span> (attributeName == kAttrSubController) {</span>
<span id="cb33-114"><a href="#cb33-114"></a>      <span class="cf">return</span> getViewAttributeString(view, <span class="ch">&#39;u</span><span class="er">isc</span><span class="ch">&#39;</span>, stringValue);</span>
<span id="cb33-115"><a href="#cb33-115"></a>    }</span>
<span id="cb33-116"><a href="#cb33-116"></a>    <span class="cf">return</span> <span class="kw">false</span>;</span>
<span id="cb33-117"><a href="#cb33-117"></a>  }</span>
<span id="cb33-118"><a href="#cb33-118"></a></span>
<span id="cb33-119"><a href="#cb33-119"></a><span class="kw">protected</span>:</span>
<span id="cb33-120"><a href="#cb33-120"></a>  <span class="at">static</span> <span class="dt">bool</span></span>
<span id="cb33-121"><a href="#cb33-121"></a>  getViewAttributeString(CView *view, <span class="at">const</span> CViewAttributeID attrID, <span class="bu">std::</span>string &amp;value)</span>
<span id="cb33-122"><a href="#cb33-122"></a>  {</span>
<span id="cb33-123"><a href="#cb33-123"></a>    <span class="dt">uint32_t</span> attrSize = <span class="dv">0</span>;</span>
<span id="cb33-124"><a href="#cb33-124"></a>    <span class="cf">if</span> (view-&gt;getAttributeSize(attrID, attrSize)) {</span>
<span id="cb33-125"><a href="#cb33-125"></a>      <span class="dt">char</span> *cstr = <span class="kw">new</span> <span class="dt">char</span>[attrSize + <span class="dv">1</span>];</span>
<span id="cb33-126"><a href="#cb33-126"></a>      <span class="cf">if</span> (view-&gt;getAttribute(attrID, attrSize, cstr, attrSize))</span>
<span id="cb33-127"><a href="#cb33-127"></a>        value = cstr;</span>
<span id="cb33-128"><a href="#cb33-128"></a>      <span class="cf">else</span></span>
<span id="cb33-129"><a href="#cb33-129"></a>        value = <span class="st">&quot;&quot;</span>;</span>
<span id="cb33-130"><a href="#cb33-130"></a>      <span class="kw">delete</span>[] cstr;</span>
<span id="cb33-131"><a href="#cb33-131"></a>      <span class="cf">return</span> <span class="kw">true</span>;</span>
<span id="cb33-132"><a href="#cb33-132"></a>    }</span>
<span id="cb33-133"><a href="#cb33-133"></a>    <span class="cf">return</span> <span class="kw">false</span>;</span>
<span id="cb33-134"><a href="#cb33-134"></a>  }</span>
<span id="cb33-135"><a href="#cb33-135"></a>};</span>
<span id="cb33-136"><a href="#cb33-136"></a></span>
<span id="cb33-137"><a href="#cb33-137"></a>WaveViewCreator __gWaveViewCreator;</span>
<span id="cb33-138"><a href="#cb33-138"></a></span>
<span id="cb33-139"><a href="#cb33-139"></a>} <span class="co">// namespace UIViewCreator</span></span>
<span id="cb33-140"><a href="#cb33-140"></a>} <span class="co">// namespace VSTGUI</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span id="cb34-1"><a href="#cb34-1"></a></span>
<span id="cb34-2"><a href="#cb34-2"></a>`<span class="fu">SomeFX/CMakeLists.txt` にファイルを追加します。</span></span>
<span id="cb34-3"><a href="#cb34-3"></a></span>
<span id="cb34-4"><a href="#cb34-4"></a><span class="fu">```cmake</span></span>
<span id="cb34-5"><a href="#cb34-5"></a><span class="fu">set</span>(plug_sources</span>
<span id="cb34-6"><a href="#cb34-6"></a>    source/plugcontroller.hpp</span>
<span id="cb34-7"><a href="#cb34-7"></a>    source/plugids.hpp</span>
<span id="cb34-8"><a href="#cb34-8"></a>    source/plugprocessor.hpp</span>
<span id="cb34-9"><a href="#cb34-9"></a>    source/version.hpp</span>
<span id="cb34-10"><a href="#cb34-10"></a>    source/plugfactory.cpp</span>
<span id="cb34-11"><a href="#cb34-11"></a>    source/plugcontroller.cpp</span>
<span id="cb34-12"><a href="#cb34-12"></a>    source/plugprocessor.cpp</span>
<span id="cb34-13"><a href="#cb34-13"></a>    source/gui/waveview.hpp        <span class="co"># 追加</span></span>
<span id="cb34-14"><a href="#cb34-14"></a>    source/gui/waveview.cpp        <span class="co"># 追加</span></span>
<span id="cb34-15"><a href="#cb34-15"></a>    source/gui/waveviewcreator.cpp <span class="co"># 追加</span></span>
<span id="cb34-16"><a href="#cb34-16"></a>)</span></code></pre></div>
<ul>
<li><code>vstgui4/vstgui/Documentation/html/md_page_create_your_own_ui_view.html</code></li>
<li><code>vstgui4/vstgui/Documentation/html/class_v_s_t_g_u_i_1_1_i_view_creator.html</code></li>
<li><code>vstgui4/vstgui/uidescription/uiattributes.h</code></li>
<li><code>vstgui4/vstgui/uidescription/detail/uiviewcreatorattributes.h</code></li>
</ul>
<h4 id="パラメータの連動">パラメータの連動</h4>
<ul>
<li>TODO 検証</li>
</ul>
<p>ここに書いてある内容は手持ちの DAW では動かなかったので検証できていません。同じ仕組みを使っている noteexpressionsynth のキーボード UI もうまく動いていなかったので、 DAW 側で実装されていない可能性が高いと判断して掲載しています。</p>
<p>UI エディタで、パラメータを受け取る側のビューの sub-controller に適当な文字列を設定します。ここでは <code>WaveViewController</code> としています。</p>
<p>コントロールクラスに <code>VST3EditorDelegate</code> を継承させて <code>createSubController</code> を実装します。 <code>SomeFX/source/plugcontroller.hpp</code> でメソッドを追加します。</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb35-1"><a href="#cb35-1"></a><span class="kw">class</span> PlugController : <span class="kw">public</span> Vst::EditController, <span class="kw">public</span> VSTGUI::VST3EditorDelegate {</span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="kw">public</span>:</span>
<span id="cb35-3"><a href="#cb35-3"></a>  <span class="co">// ...</span></span>
<span id="cb35-4"><a href="#cb35-4"></a></span>
<span id="cb35-5"><a href="#cb35-5"></a>  VSTGUI::IController *createSubController(</span>
<span id="cb35-6"><a href="#cb35-6"></a>    VSTGUI::UTF8StringPtr name,</span>
<span id="cb35-7"><a href="#cb35-7"></a>    <span class="at">const</span> VSTGUI::IUIDescription *description,</span>
<span id="cb35-8"><a href="#cb35-8"></a>    VSTGUI::VST3Editor *editor) SMTG_OVERRIDE;</span>
<span id="cb35-9"><a href="#cb35-9"></a>};</span></code></pre></div>
<p><code>SomeFX/source/plugcontroller.cpp</code> に実装を追加します。</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb36-1"><a href="#cb36-1"></a><span class="kw">class</span> WaveViewController : <span class="kw">public</span> DelegationController {</span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="kw">public</span>:</span>
<span id="cb36-3"><a href="#cb36-3"></a>  WaveViewController(IController *controller) : DelegationController(controller) {}</span>
<span id="cb36-4"><a href="#cb36-4"></a></span>
<span id="cb36-5"><a href="#cb36-5"></a>  ~WaveViewController()</span>
<span id="cb36-6"><a href="#cb36-6"></a>  {</span>
<span id="cb36-7"><a href="#cb36-7"></a>    <span class="cf">if</span> (waveview != <span class="kw">nullptr</span>) waveview-&gt;forget();</span>
<span id="cb36-8"><a href="#cb36-8"></a>  }</span>
<span id="cb36-9"><a href="#cb36-9"></a></span>
<span id="cb36-10"><a href="#cb36-10"></a>  CView *</span>
<span id="cb36-11"><a href="#cb36-11"></a>  verifyView(CView *view, <span class="at">const</span> UIAttributes &amp;attributes, IUIDescription *description)</span>
<span id="cb36-12"><a href="#cb36-12"></a>  {</span>
<span id="cb36-13"><a href="#cb36-13"></a>    <span class="kw">auto</span> control = <span class="kw">dynamic_cast</span>&lt;WaveView *&gt;(view);</span>
<span id="cb36-14"><a href="#cb36-14"></a>    <span class="cf">if</span> (control != <span class="kw">nullptr</span>) { <span class="co">// 必要に応じてタグのチェックを追加する。</span></span>
<span id="cb36-15"><a href="#cb36-15"></a>      waveview = control;</span>
<span id="cb36-16"><a href="#cb36-16"></a>      waveview-&gt;remember();</span>
<span id="cb36-17"><a href="#cb36-17"></a>    }</span>
<span id="cb36-18"><a href="#cb36-18"></a>    <span class="cf">return</span> controller-&gt;verifyView(view, attributes, description);</span>
<span id="cb36-19"><a href="#cb36-19"></a>  }</span>
<span id="cb36-20"><a href="#cb36-20"></a></span>
<span id="cb36-21"><a href="#cb36-21"></a>  <span class="dt">void</span> valueChanged(CControl *pControl) <span class="kw">override</span></span>
<span id="cb36-22"><a href="#cb36-22"></a>  {</span>
<span id="cb36-23"><a href="#cb36-23"></a>    <span class="co">// 多分 DAW がこのメソッドの呼び出しを実装していない。</span></span>
<span id="cb36-24"><a href="#cb36-24"></a>    <span class="co">// Reaper 5.980 と FL Studio 20.5 では動かなかった。</span></span>
<span id="cb36-25"><a href="#cb36-25"></a></span>
<span id="cb36-26"><a href="#cb36-26"></a>    Vst::ParamID tag = pControl-&gt;getTag();</span>
<span id="cb36-27"><a href="#cb36-27"></a></span>
<span id="cb36-28"><a href="#cb36-28"></a>    <span class="cf">if</span> (waveview == <span class="kw">nullptr</span>) <span class="cf">return</span>;</span>
<span id="cb36-29"><a href="#cb36-29"></a></span>
<span id="cb36-30"><a href="#cb36-30"></a>    <span class="cf">if</span> (tag == ParameterID::volume) {</span>
<span id="cb36-31"><a href="#cb36-31"></a>      waveview-&gt;gain = pControl-&gt;getValueNormalized();</span>
<span id="cb36-32"><a href="#cb36-32"></a>      waveview-&gt;setDirty(<span class="kw">true</span>);</span>
<span id="cb36-33"><a href="#cb36-33"></a>    }</span>
<span id="cb36-34"><a href="#cb36-34"></a>  }</span>
<span id="cb36-35"><a href="#cb36-35"></a></span>
<span id="cb36-36"><a href="#cb36-36"></a><span class="kw">protected</span>:</span>
<span id="cb36-37"><a href="#cb36-37"></a>  WaveView *waveview = <span class="kw">nullptr</span>;</span>
<span id="cb36-38"><a href="#cb36-38"></a>};</span>
<span id="cb36-39"><a href="#cb36-39"></a></span>
<span id="cb36-40"><a href="#cb36-40"></a>IController *PlugController::createSubController(</span>
<span id="cb36-41"><a href="#cb36-41"></a>  UTF8StringPtr name, <span class="at">const</span> IUIDescription *description, VST3Editor *editor)</span>
<span id="cb36-42"><a href="#cb36-42"></a>{</span>
<span id="cb36-43"><a href="#cb36-43"></a>  <span class="cf">if</span> (name == <span class="st">&quot;WaveViewController&quot;</span>) {</span>
<span id="cb36-44"><a href="#cb36-44"></a>    <span class="cf">return</span> <span class="kw">new</span> WaveViewController(editor);</span>
<span id="cb36-45"><a href="#cb36-45"></a>  }</span>
<span id="cb36-46"><a href="#cb36-46"></a>  <span class="cf">return</span> <span class="kw">nullptr</span>;</span>
<span id="cb36-47"><a href="#cb36-47"></a>}</span></code></pre></div>
<p>これで動くはずですが、コメントで書いたように <code>DelegationController</code> の <code>valueChanged</code> がホストから呼び出されていないようです。ドキュメンテーションの <code>vstgui4/vstgui/Documentation/html/page_uidescription_editor.html</code> では <code>DelegationController</code> の <code>notify</code> を使っていますが、 <code>CControl::kMessageValueChanged</code> は VSTGUI 4.8 で廃止されたので動きません。</p>
<ul>
<li><code>vstgui4/vstgui/Documentation/html/page_uidescription_editor.html</code></li>
<li><code>vstgui4/vstgui/Documentation/html/page_news_and_changes.html</code></li>
</ul>
<h3 id="コードでgui">コードでGUI</h3>
<p><code>VSTGUIEditor</code> をベースにしてコードでGUIを作ります。</p>
<p><code>VSTGUIEditor</code> を使った GUI の作成についてはうつぼかずらさんによる<a href="http://vstcpp.wpblog.jp/">C++でVST作り</a>が参考になります。ここではC++でVST作りで紹介されていない内容について扱っています。</p>
<ul>
<li><a href="http://vstcpp.wpblog.jp/">C++でVST作り</a></li>
</ul>
<h4 id="リフレッシュレートの設定">リフレッシュレートの設定</h4>
<p><code>VSTGUIEditor</code> の <code>setIdleRate</code> でリフレッシュレートを変更できます。指定する値の単位は ms (ミリ秒) で、デフォルト値は 100ms (10Hz) です。カスタムビューの更新が遅く感じるときなどに変更してみてください。</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb37-1"><a href="#cb37-1"></a><span class="dt">bool</span> PlugEditor::open(<span class="dt">void</span> *parent, <span class="at">const</span> PlatformType &amp;platformType)</span>
<span id="cb37-2"><a href="#cb37-2"></a>{</span>
<span id="cb37-3"><a href="#cb37-3"></a>  setIdleRate(<span class="dv">1000</span> / <span class="dv">60</span>);</span>
<span id="cb37-4"><a href="#cb37-4"></a></span>
<span id="cb37-5"><a href="#cb37-5"></a>  <span class="co">// ...</span></span>
<span id="cb37-6"><a href="#cb37-6"></a>}</span></code></pre></div>
<ul>
<li><code>public.sdk/source/vst/vstguieditor.cpp</code></li>
<li><code>vstgui4/vstgui/lib/cvstguitimer.h</code></li>
</ul>
<h4 id="カスタムビューの実装と関連するコントロールの表示の変更">カスタムビューの実装と関連するコントロールの表示の変更</h4>
<p>あるコントロールの値を変更したときに、連動して別のコントロールの値や表示を変更したい時があります。ここでは例としてコントロールの値に応じてカスタムビューで波形を表示するようにします。</p>
<p>カスタムビューは <code>CView</code> を継承したクラスならどれを継承しても作ることができます。例えばスライダーの見た目を変更したいなら <code>CSlider</code> を継承する、テキストを表示するカスタムビューを作りたいときは <code>CParamDisplay</code> を継承するといった形で実装の手間を減らせるときがあります。継承して使えるクラスを探すときは <code>vstgui4/vstgui/lib</code> と <code>vstgui4/vstgui/lib/controls</code> を覗いてみてください。</p>
<p>ここでは波形を表示するだけなので <code>CControl</code> を継承して <code>draw</code> をオーバーライドしただけの <code>WaveView</code> というカスタムビューを作ります。 <code>waveview.hpp</code> の内容です。</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb38-1"><a href="#cb38-1"></a><span class="pp">#pragma once</span></span>
<span id="cb38-2"><a href="#cb38-2"></a></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="pp">#include </span><span class="im">&quot;vstgui/vstgui.h&quot;</span></span>
<span id="cb38-4"><a href="#cb38-4"></a></span>
<span id="cb38-5"><a href="#cb38-5"></a><span class="kw">namespace</span> VSTGUI {</span>
<span id="cb38-6"><a href="#cb38-6"></a></span>
<span id="cb38-7"><a href="#cb38-7"></a><span class="kw">class</span> WaveView : <span class="kw">public</span> CControl {</span>
<span id="cb38-8"><a href="#cb38-8"></a><span class="kw">public</span>:</span>
<span id="cb38-9"><a href="#cb38-9"></a>  WaveView(<span class="at">const</span> CRect &amp;size);</span>
<span id="cb38-10"><a href="#cb38-10"></a></span>
<span id="cb38-11"><a href="#cb38-11"></a>  <span class="dt">void</span> draw(CDrawContext *pContext) <span class="kw">override</span>;</span>
<span id="cb38-12"><a href="#cb38-12"></a></span>
<span id="cb38-13"><a href="#cb38-13"></a>  CLASS_METHODS(WaveView, CControl);</span>
<span id="cb38-14"><a href="#cb38-14"></a></span>
<span id="cb38-15"><a href="#cb38-15"></a>  <span class="dt">double</span> lfo(<span class="dt">double</span> phase);</span>
<span id="cb38-16"><a href="#cb38-16"></a></span>
<span id="cb38-17"><a href="#cb38-17"></a>  <span class="dt">double</span> amount = <span class="fl">0.9</span>;</span>
<span id="cb38-18"><a href="#cb38-18"></a>  <span class="dt">double</span> shape = <span class="fl">0.0</span>;</span>
<span id="cb38-19"><a href="#cb38-19"></a>  <span class="dt">double</span> phase = <span class="fl">0.0</span>;</span>
<span id="cb38-20"><a href="#cb38-20"></a></span>
<span id="cb38-21"><a href="#cb38-21"></a><span class="kw">protected</span>:</span>
<span id="cb38-22"><a href="#cb38-22"></a>  CLineStyle lineStyle{CLineStyle::kLineCapRound, CLineStyle::kLineJoinRound};</span>
<span id="cb38-23"><a href="#cb38-23"></a>  CDrawContext::PointList points;</span>
<span id="cb38-24"><a href="#cb38-24"></a>};</span>
<span id="cb38-25"><a href="#cb38-25"></a></span>
<span id="cb38-26"><a href="#cb38-26"></a>} <span class="co">// namespace VSTGUI</span></span></code></pre></div>
<p><code>waveview.cpp</code> の内容です。ここでは描画する波形が簡単なので <code>WaveView::lfo</code> として GUI 側で実装しています。コードがより複雑になるときは GUI 側に波形を生成するコードを書かずに、プロセッサクラスから信号処理の部分をヘッダにまとめてインクルードすることをお勧めします。</p>
<ul>
<li>TODO</li>
</ul>
<div class="sourceCode" id="cb39"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb39-1"><a href="#cb39-1"></a><span class="pp">#include </span><span class="im">&quot;waveview.hpp&quot;</span></span>
<span id="cb39-2"><a href="#cb39-2"></a></span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="pp">#include </span><span class="im">&lt;cmath&gt;</span></span>
<span id="cb39-4"><a href="#cb39-4"></a></span>
<span id="cb39-5"><a href="#cb39-5"></a><span class="kw">namespace</span> VSTGUI {</span>
<span id="cb39-6"><a href="#cb39-6"></a></span>
<span id="cb39-7"><a href="#cb39-7"></a>WaveView::WaveView(<span class="at">const</span> CRect &amp;size) : CControl(size) {}</span>
<span id="cb39-8"><a href="#cb39-8"></a></span>
<span id="cb39-9"><a href="#cb39-9"></a><span class="dt">void</span> WaveView::draw(CDrawContext *pContext)</span>
<span id="cb39-10"><a href="#cb39-10"></a>{</span>
<span id="cb39-11"><a href="#cb39-11"></a>  <span class="co">// アンチエイリアスを有効にする。</span></span>
<span id="cb39-12"><a href="#cb39-12"></a>  pContext-&gt;setDrawMode(CDrawMode(CDrawModeFlags::kAntiAliasing));</span>
<span id="cb39-13"><a href="#cb39-13"></a></span>
<span id="cb39-14"><a href="#cb39-14"></a>  <span class="co">// 座標変換して (x, y) = (0, 0) がビューの左上となるようにする。</span></span>
<span id="cb39-15"><a href="#cb39-15"></a>  <span class="co">// 座標変換しないときの (0, 0) はプラグインウィンドウの左上になる。</span></span>
<span id="cb39-16"><a href="#cb39-16"></a>  CDrawContext::Transform t(</span>
<span id="cb39-17"><a href="#cb39-17"></a>    *pContext, CGraphicsTransform().translate(getViewSize().getTopLeft()));</span>
<span id="cb39-18"><a href="#cb39-18"></a></span>
<span id="cb39-19"><a href="#cb39-19"></a>  <span class="at">const</span> <span class="kw">auto</span> width = getWidth();</span>
<span id="cb39-20"><a href="#cb39-20"></a>  <span class="at">const</span> <span class="kw">auto</span> height = getHeight();</span>
<span id="cb39-21"><a href="#cb39-21"></a>  <span class="at">const</span> <span class="dt">double</span> borderWidth = <span class="fl">2.0</span>;</span>
<span id="cb39-22"><a href="#cb39-22"></a>  <span class="at">const</span> <span class="dt">double</span> halfBorderWidth = borderWidth / <span class="fl">2.0</span>;</span>
<span id="cb39-23"><a href="#cb39-23"></a></span>
<span id="cb39-24"><a href="#cb39-24"></a>  <span class="co">// Background.</span></span>
<span id="cb39-25"><a href="#cb39-25"></a>  <span class="at">const</span> <span class="kw">auto</span> bgColor = CColor(<span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>);</span>
<span id="cb39-26"><a href="#cb39-26"></a>  pContext-&gt;setLineWidth(borderWidth);</span>
<span id="cb39-27"><a href="#cb39-27"></a>  pContext-&gt;setFillColor(bgColor);</span>
<span id="cb39-28"><a href="#cb39-28"></a>  pContext-&gt;drawRect(CRect(<span class="fl">0.0</span>, <span class="fl">0.0</span>, width, height), kDrawFilled);</span>
<span id="cb39-29"><a href="#cb39-29"></a></span>
<span id="cb39-30"><a href="#cb39-30"></a>  <span class="co">// Waveform.</span></span>
<span id="cb39-31"><a href="#cb39-31"></a>  pContext-&gt;setLineWidth(<span class="fl">2.0</span>);</span>
<span id="cb39-32"><a href="#cb39-32"></a>  pContext-&gt;setLineStyle(lineStyle);</span>
<span id="cb39-33"><a href="#cb39-33"></a>  pContext-&gt;setFrameColor(CColor(<span class="dv">19</span>, <span class="dv">193</span>, <span class="dv">54</span>, <span class="dv">255</span>));</span>
<span id="cb39-34"><a href="#cb39-34"></a>  <span class="at">const</span> <span class="dt">size_t</span> size = (<span class="dt">size_t</span>)(width + <span class="fl">1.0</span>);</span>
<span id="cb39-35"><a href="#cb39-35"></a>  <span class="cf">if</span> (points.size() != size) points.resize(size);</span>
<span id="cb39-36"><a href="#cb39-36"></a>  <span class="cf">for</span> (<span class="dt">size_t</span> x = <span class="dv">0</span>; x &lt; points.size(); ++x)</span>
<span id="cb39-37"><a href="#cb39-37"></a>    points[x] = CPoint((CCoord)x, height * lfo(x / width));</span>
<span id="cb39-38"><a href="#cb39-38"></a>  pContext-&gt;drawPolygon(points);</span>
<span id="cb39-39"><a href="#cb39-39"></a></span>
<span id="cb39-40"><a href="#cb39-40"></a>  <span class="co">// Always draw border at last. Otherwise, inner object will be drawn over border.</span></span>
<span id="cb39-41"><a href="#cb39-41"></a>  <span class="at">const</span> <span class="kw">auto</span> borderColor = CColor(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">255</span>);</span>
<span id="cb39-42"><a href="#cb39-42"></a>  pContext-&gt;setFrameColor(borderColor);</span>
<span id="cb39-43"><a href="#cb39-43"></a>  pContext-&gt;drawRect(</span>
<span id="cb39-44"><a href="#cb39-44"></a>    CRect(halfBorderWidth, halfBorderWidth, width, height), kDrawStroked);</span>
<span id="cb39-45"><a href="#cb39-45"></a></span>
<span id="cb39-46"><a href="#cb39-46"></a>  setDirty(<span class="kw">false</span>);</span>
<span id="cb39-47"><a href="#cb39-47"></a>}</span>
<span id="cb39-48"><a href="#cb39-48"></a></span>
<span id="cb39-49"><a href="#cb39-49"></a><span class="dt">double</span> WaveView::lfo(<span class="dt">double</span> phase)</span>
<span id="cb39-50"><a href="#cb39-50"></a>{</span>
<span id="cb39-51"><a href="#cb39-51"></a>  <span class="at">const</span> <span class="dt">double</span> pi = <span class="fl">3.14159265358979323846</span>;</span>
<span id="cb39-52"><a href="#cb39-52"></a></span>
<span id="cb39-53"><a href="#cb39-53"></a>  phase = <span class="kw">this</span>-&gt;phase + phase * <span class="dv">2</span> * pi;</span>
<span id="cb39-54"><a href="#cb39-54"></a>  <span class="cf">if</span> (phase &gt; <span class="dv">2</span> * pi) phase -= <span class="dv">2</span> * pi;</span>
<span id="cb39-55"><a href="#cb39-55"></a>  <span class="kw">auto</span> sign = (pi &lt; phase) - (phase &lt; pi);</span>
<span id="cb39-56"><a href="#cb39-56"></a>  <span class="kw">auto</span> wave = amount * sign * pow(abs(sin(phase)), shape);</span>
<span id="cb39-57"><a href="#cb39-57"></a>  <span class="cf">return</span> (wave + <span class="fl">1.0</span>) * <span class="fl">0.5</span>;</span>
<span id="cb39-58"><a href="#cb39-58"></a>}</span>
<span id="cb39-59"><a href="#cb39-59"></a></span>
<span id="cb39-60"><a href="#cb39-60"></a>} <span class="co">// namespace VSTGUI</span></span></code></pre></div>
<p>エディタクラスに関数を追加します。</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb40-1"><a href="#cb40-1"></a><span class="kw">class</span> PlugEditor : <span class="kw">public</span> VSTGUIEditor, <span class="kw">public</span> IControlListener {</span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="co">// ...</span></span>
<span id="cb40-3"><a href="#cb40-3"></a></span>
<span id="cb40-4"><a href="#cb40-4"></a>  <span class="dt">void</span> addWaveView(<span class="at">const</span> CRect &amp;size);</span>
<span id="cb40-5"><a href="#cb40-5"></a></span>
<span id="cb40-6"><a href="#cb40-6"></a><span class="kw">protected</span>:</span>
<span id="cb40-7"><a href="#cb40-7"></a>  ParamValue getPlainValue(ParamID tag);</span>
<span id="cb40-8"><a href="#cb40-8"></a></span>
<span id="cb40-9"><a href="#cb40-9"></a>  <span class="at">const</span> CRect WaveViewSize{<span class="fl">100.0</span>, <span class="fl">100.0</span>, <span class="fl">200.0</span>, <span class="fl">200.0</span>};</span>
<span id="cb40-10"><a href="#cb40-10"></a></span>
<span id="cb40-11"><a href="#cb40-11"></a>  <span class="co">// getViewAt が反応するように 1 ピクセル内側を指定する。</span></span>
<span id="cb40-12"><a href="#cb40-12"></a>  <span class="at">const</span> CPoint WaveViewPos{WaveViewSize.left + <span class="fl">1.0</span>, WaveViewSize.top + <span class="fl">1.0</span>};</span>
<span id="cb40-13"><a href="#cb40-13"></a></span>
<span id="cb40-14"><a href="#cb40-14"></a><span class="co">// ...</span></span>
<span id="cb40-15"><a href="#cb40-15"></a>};</span></code></pre></div>
<p><code>addWaveView</code> の実装です。 <code>parameter.hpp</code> で定義したパラメータIDを使ってコントローラから初期値を取得しています。</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb41-1"><a href="#cb41-1"></a><span class="pp">#include </span><span class="im">&quot;parameter.hpp&quot;</span></span>
<span id="cb41-2"><a href="#cb41-2"></a></span>
<span id="cb41-3"><a href="#cb41-3"></a><span class="dt">void</span> PlugEditor::addWaveView(<span class="at">const</span> CRect &amp;size)</span>
<span id="cb41-4"><a href="#cb41-4"></a>{</span>
<span id="cb41-5"><a href="#cb41-5"></a>  <span class="kw">auto</span> view = <span class="kw">new</span> WaveView(size);</span>
<span id="cb41-6"><a href="#cb41-6"></a>  view-&gt;shape = getPlainValue(SomePlugin::ParameterID::lfoShape);</span>
<span id="cb41-7"><a href="#cb41-7"></a>  view-&gt;phase = getPlainValue(SomePlugin::ParameterID::lfoInitialPhase);</span>
<span id="cb41-8"><a href="#cb41-8"></a>  frame-&gt;addView(view);</span>
<span id="cb41-9"><a href="#cb41-9"></a>}</span>
<span id="cb41-10"><a href="#cb41-10"></a></span>
<span id="cb41-11"><a href="#cb41-11"></a>ParamValue PlugEditor::getPlainValue(ParamID tag)</span>
<span id="cb41-12"><a href="#cb41-12"></a>{</span>
<span id="cb41-13"><a href="#cb41-13"></a>  <span class="kw">auto</span> normalized = controller-&gt;getParamNormalized(tag);</span>
<span id="cb41-14"><a href="#cb41-14"></a>  <span class="cf">return</span> controller-&gt;normalizedParamToPlain(tag, normalized);</span>
<span id="cb41-15"><a href="#cb41-15"></a>};</span></code></pre></div>
<p><code>open</code> で <code>WaveView</code> を作成します。</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb42-1"><a href="#cb42-1"></a><span class="dt">bool</span> PlugEditor::open(<span class="dt">void</span> *parent, <span class="at">const</span> PlatformType &amp;platformType)</span>
<span id="cb42-2"><a href="#cb42-2"></a>{</span>
<span id="cb42-3"><a href="#cb42-3"></a>  <span class="co">// ...</span></span>
<span id="cb42-4"><a href="#cb42-4"></a></span>
<span id="cb42-5"><a href="#cb42-5"></a>  addWaveView(WaveViewSize);</span>
<span id="cb42-6"><a href="#cb42-6"></a></span>
<span id="cb42-7"><a href="#cb42-7"></a>  <span class="co">// ...</span></span>
<span id="cb42-8"><a href="#cb42-8"></a>}</span></code></pre></div>
<p>エディタクラスの <code>valueChanged</code> で関連するコントロールの変更を検知して <code>WaveView</code> を更新します。ここでは <code>VSTGUIEditor::open</code> で作成したコントロールを取得するために <code>getViewAt</code> を使っています。 <code>getViewAt</code> に渡している <code>WaveViewPos</code> はエディタクラスのメンバとして定義した <code>WaveView</code> の位置です。</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb43-1"><a href="#cb43-1"></a><span class="dt">void</span> PlugEditor::valueChanged(CControl *pControl)</span>
<span id="cb43-2"><a href="#cb43-2"></a>{</span>
<span id="cb43-3"><a href="#cb43-3"></a>  ParamID tag = pControl-&gt;getTag();</span>
<span id="cb43-4"><a href="#cb43-4"></a>  ParamValue value = pControl-&gt;getValueNormalized();</span>
<span id="cb43-5"><a href="#cb43-5"></a>  controller-&gt;setParamNormalized(tag, value);</span>
<span id="cb43-6"><a href="#cb43-6"></a>  controller-&gt;performEdit(tag, value);</span>
<span id="cb43-7"><a href="#cb43-7"></a></span>
<span id="cb43-8"><a href="#cb43-8"></a>  <span class="cf">if</span> (tag == SevenDelay::ParameterID::lfoShape) {</span>
<span id="cb43-9"><a href="#cb43-9"></a>    <span class="kw">auto</span> some = <span class="kw">dynamic_cast</span>&lt;WaveView *&gt;(frame-&gt;getViewAt(WaveViewPos));</span>
<span id="cb43-10"><a href="#cb43-10"></a>    <span class="cf">if</span> (some == <span class="kw">nullptr</span>) <span class="cf">return</span>;</span>
<span id="cb43-11"><a href="#cb43-11"></a>    some-&gt;shape = getPlainValue(tag);</span>
<span id="cb43-12"><a href="#cb43-12"></a>    some-&gt;setDirty(<span class="kw">true</span>);</span>
<span id="cb43-13"><a href="#cb43-13"></a>  } <span class="cf">else</span> <span class="cf">if</span> (tag == SevenDelay::ParameterID::lfoInitialPhase) {</span>
<span id="cb43-14"><a href="#cb43-14"></a>    <span class="kw">auto</span> some = <span class="kw">dynamic_cast</span>&lt;WaveView *&gt;(frame-&gt;getViewAt(WaveViewPos));</span>
<span id="cb43-15"><a href="#cb43-15"></a>    <span class="cf">if</span> (some == <span class="kw">nullptr</span>) <span class="cf">return</span>;</span>
<span id="cb43-16"><a href="#cb43-16"></a>    some-&gt;phase = getPlainValue(tag);</span>
<span id="cb43-17"><a href="#cb43-17"></a>    some-&gt;setDirty(<span class="kw">true</span>);</span>
<span id="cb43-18"><a href="#cb43-18"></a>  }</span>
<span id="cb43-19"><a href="#cb43-19"></a>}</span></code></pre></div>
<p>コントロールを取得する別の方法としては <code>frame-&gt;getView</code> があります。引数の <code>index</code> がどういう値なのかドキュメンテーションに書いていなかったのでここでは使っていません。興味のある方は <code>vstgui4/vstgui/lib/cviewcontainer.*</code> を読んでみてください。</p>
<h4 id="スプラッシュスクリーンの追加">スプラッシュスクリーンの追加</h4>
<p><code>CSplashScreen</code> でスプラッシュスクリーンを作成できます。</p>
<p>エディタクラスにスプラッシュスクリーンを追加する関数を作ります。</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb44-1"><a href="#cb44-1"></a><span class="kw">class</span> PlugEditor : <span class="kw">public</span> VSTGUIEditor, <span class="kw">public</span> IControlListener {</span>
<span id="cb44-2"><a href="#cb44-2"></a>  <span class="co">// ...</span></span>
<span id="cb44-3"><a href="#cb44-3"></a></span>
<span id="cb44-4"><a href="#cb44-4"></a>  <span class="dt">void</span> addSplashScreen(CRect &amp;buttonRect, CRect splashRect);</span>
<span id="cb44-5"><a href="#cb44-5"></a></span>
<span id="cb44-6"><a href="#cb44-6"></a>  <span class="co">// ...</span></span>
<span id="cb44-7"><a href="#cb44-7"></a>};</span></code></pre></div>
<p><code>addSplashScreen</code> の実装です。ここではスプラッシュスクリーンとしてカスタムビューの <code>CreditView</code> が表示されるようにしています。開いたスプラッシュスクリーンをクリックしたときに閉じるようにするにはカスタムビュー側の <code>setListener</code> に <code>CSplashScreen</code> を渡しておく必要があります。 <code>setListener</code> は <code>CControl</code> で実装されています。</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb45-1"><a href="#cb45-1"></a><span class="dt">void</span> PlugEditor::addSplashScreen(CRect &amp;buttonRect, CRect splashRect)</span>
<span id="cb45-2"><a href="#cb45-2"></a>{</span>
<span id="cb45-3"><a href="#cb45-3"></a>  <span class="kw">auto</span> credit = <span class="kw">new</span> CreditView(splashRect, <span class="kw">nullptr</span>);</span>
<span id="cb45-4"><a href="#cb45-4"></a>  <span class="kw">auto</span> splash = <span class="kw">new</span> CSplashScreen(buttonRect, <span class="kw">this</span>, -<span class="dv">666</span>, credit);</span>
<span id="cb45-5"><a href="#cb45-5"></a>  credit-&gt;setListener(splash);</span>
<span id="cb45-6"><a href="#cb45-6"></a>  frame-&gt;addView(splash);</span>
<span id="cb45-7"><a href="#cb45-7"></a>}</span></code></pre></div>
<p><code>open</code> でスプラッシュスクリーンを追加します。</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb46-1"><a href="#cb46-1"></a><span class="dt">bool</span> PlugEditor::open(<span class="dt">void</span> *parent, <span class="at">const</span> PlatformType &amp;platformType)</span>
<span id="cb46-2"><a href="#cb46-2"></a>{</span>
<span id="cb46-3"><a href="#cb46-3"></a>  <span class="co">// ...</span></span>
<span id="cb46-4"><a href="#cb46-4"></a></span>
<span id="cb46-5"><a href="#cb46-5"></a>  <span class="co">// viewRect はウィンドウの大きさ。</span></span>
<span id="cb46-6"><a href="#cb46-6"></a>  addSplashScreen(</span>
<span id="cb46-7"><a href="#cb46-7"></a>    CRect(<span class="fl">30.0</span>, <span class="fl">340.0</span>, <span class="fl">190.0</span>, <span class="fl">380.0</span>),</span>
<span id="cb46-8"><a href="#cb46-8"></a>    CRect(</span>
<span id="cb46-9"><a href="#cb46-9"></a>      viewRect.left + <span class="fl">200.0</span>,</span>
<span id="cb46-10"><a href="#cb46-10"></a>      viewRect.top + <span class="fl">20.0</span>,</span>
<span id="cb46-11"><a href="#cb46-11"></a>      viewRect.right - <span class="fl">200.0</span>,</span>
<span id="cb46-12"><a href="#cb46-12"></a>      viewRect.bottom - <span class="fl">20.0</span>));</span>
<span id="cb46-13"><a href="#cb46-13"></a></span>
<span id="cb46-14"><a href="#cb46-14"></a>  <span class="co">// ...</span></span>
<span id="cb46-15"><a href="#cb46-15"></a>}</span></code></pre></div>
<p><code>source/gui/splash.hpp</code> を作って <code>CreditView</code> を実装します。</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb47-1"><a href="#cb47-1"></a><span class="pp">#pragma once</span></span>
<span id="cb47-2"><a href="#cb47-2"></a></span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="pp">#include </span><span class="im">&quot;vstgui/vstgui.h&quot;</span></span>
<span id="cb47-4"><a href="#cb47-4"></a></span>
<span id="cb47-5"><a href="#cb47-5"></a><span class="kw">namespace</span> Steinberg {</span>
<span id="cb47-6"><a href="#cb47-6"></a><span class="kw">namespace</span> Vst {</span>
<span id="cb47-7"><a href="#cb47-7"></a></span>
<span id="cb47-8"><a href="#cb47-8"></a><span class="kw">using</span> <span class="kw">namespace</span> VSTGUI;</span>
<span id="cb47-9"><a href="#cb47-9"></a></span>
<span id="cb47-10"><a href="#cb47-10"></a><span class="kw">class</span> CreditView : <span class="kw">public</span> CControl {</span>
<span id="cb47-11"><a href="#cb47-11"></a><span class="kw">public</span>:</span>
<span id="cb47-12"><a href="#cb47-12"></a>  CreditView(<span class="at">const</span> CRect &amp;size, IControlListener *listener) : CControl(size, listener) {}</span>
<span id="cb47-13"><a href="#cb47-13"></a></span>
<span id="cb47-14"><a href="#cb47-14"></a>  <span class="dt">void</span> draw(CDrawContext *pContext) <span class="kw">override</span>;</span>
<span id="cb47-15"><a href="#cb47-15"></a></span>
<span id="cb47-16"><a href="#cb47-16"></a>  CMouseEventResult onMouseDown(CPoint &amp;where, <span class="at">const</span> CButtonState &amp;buttons) <span class="kw">override</span></span>
<span id="cb47-17"><a href="#cb47-17"></a>  {</span>
<span id="cb47-18"><a href="#cb47-18"></a>    <span class="cf">if</span> (buttons.isLeftButton()) {</span>
<span id="cb47-19"><a href="#cb47-19"></a>      valueChanged();</span>
<span id="cb47-20"><a href="#cb47-20"></a>      <span class="cf">return</span> kMouseDownEventHandledButDontNeedMovedOrUpEvents;</span>
<span id="cb47-21"><a href="#cb47-21"></a>    }</span>
<span id="cb47-22"><a href="#cb47-22"></a>    <span class="cf">return</span> kMouseEventNotHandled;</span>
<span id="cb47-23"><a href="#cb47-23"></a>  }</span>
<span id="cb47-24"><a href="#cb47-24"></a></span>
<span id="cb47-25"><a href="#cb47-25"></a>  CLASS_METHODS(CreditView, CControl)</span>
<span id="cb47-26"><a href="#cb47-26"></a></span>
<span id="cb47-27"><a href="#cb47-27"></a><span class="kw">private</span>:</span>
<span id="cb47-28"><a href="#cb47-28"></a>  UTF8String fontName{<span class="st">&quot;DejaVu Sans Mono&quot;</span>};</span>
<span id="cb47-29"><a href="#cb47-29"></a>  CCoord fontSize = <span class="fl">18.0</span>;</span>
<span id="cb47-30"><a href="#cb47-30"></a>  CCoord fontSizeTitle = <span class="fl">24.0</span>;</span>
<span id="cb47-31"><a href="#cb47-31"></a>};</span>
<span id="cb47-32"><a href="#cb47-32"></a></span>
<span id="cb47-33"><a href="#cb47-33"></a>} <span class="co">// namespace Vst</span></span>
<span id="cb47-34"><a href="#cb47-34"></a>} <span class="co">// namespace Steinberg</span></span></code></pre></div>
<p><code>source/gui/splash.cpp</code> を作ります。</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb48-1"><a href="#cb48-1"></a><span class="pp">#include </span><span class="im">&quot;splash.hpp&quot;</span></span>
<span id="cb48-2"><a href="#cb48-2"></a></span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="kw">namespace</span> Steinberg {</span>
<span id="cb48-4"><a href="#cb48-4"></a><span class="kw">namespace</span> Vst {</span>
<span id="cb48-5"><a href="#cb48-5"></a></span>
<span id="cb48-6"><a href="#cb48-6"></a><span class="kw">using</span> <span class="kw">namespace</span> VSTGUI;</span>
<span id="cb48-7"><a href="#cb48-7"></a></span>
<span id="cb48-8"><a href="#cb48-8"></a><span class="dt">void</span> CreditView::draw(CDrawContext *pContext)</span>
<span id="cb48-9"><a href="#cb48-9"></a>{</span>
<span id="cb48-10"><a href="#cb48-10"></a>  pContext-&gt;setDrawMode(CDrawMode(CDrawModeFlags::kAntiAliasing));</span>
<span id="cb48-11"><a href="#cb48-11"></a>  CDrawContext::Transform t(</span>
<span id="cb48-12"><a href="#cb48-12"></a>    *pContext, CGraphicsTransform().translate(getViewSize().getTopLeft()));</span>
<span id="cb48-13"><a href="#cb48-13"></a></span>
<span id="cb48-14"><a href="#cb48-14"></a>  <span class="at">const</span> <span class="kw">auto</span> width = getWidth();</span>
<span id="cb48-15"><a href="#cb48-15"></a>  <span class="at">const</span> <span class="kw">auto</span> height = getHeight();</span>
<span id="cb48-16"><a href="#cb48-16"></a>  <span class="at">const</span> <span class="dt">double</span> borderWidth = <span class="fl">8.0</span>;</span>
<span id="cb48-17"><a href="#cb48-17"></a>  <span class="at">const</span> <span class="dt">double</span> halfBorderWidth = borderWidth / <span class="fl">2.0</span>;</span>
<span id="cb48-18"><a href="#cb48-18"></a></span>
<span id="cb48-19"><a href="#cb48-19"></a>  <span class="co">// Background.</span></span>
<span id="cb48-20"><a href="#cb48-20"></a>  <span class="at">const</span> <span class="kw">auto</span> bgColor = CColor(<span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>);</span>
<span id="cb48-21"><a href="#cb48-21"></a>  pContext-&gt;setLineWidth(borderWidth);</span>
<span id="cb48-22"><a href="#cb48-22"></a>  pContext-&gt;setFillColor(bgColor);</span>
<span id="cb48-23"><a href="#cb48-23"></a>  pContext-&gt;drawRect(CRect(<span class="fl">0.0</span>, <span class="fl">0.0</span>, width, height), kDrawFilled);</span>
<span id="cb48-24"><a href="#cb48-24"></a></span>
<span id="cb48-25"><a href="#cb48-25"></a>  pContext-&gt;setFont(</span>
<span id="cb48-26"><a href="#cb48-26"></a>    <span class="kw">new</span> CFontDesc(fontName, fontSizeTitle, CTxtFace::kBoldFace | CTxtFace::kItalicFace));</span>
<span id="cb48-27"><a href="#cb48-27"></a>  pContext-&gt;setFontColor(CColor(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">255</span>));</span>
<span id="cb48-28"><a href="#cb48-28"></a>  pContext-&gt;drawString(</span>
<span id="cb48-29"><a href="#cb48-29"></a>    UTF8String(<span class="st">&quot;🐸🍻🐨🍻🐰&quot;</span>).getPlatformString(), CPoint(<span class="fl">20.0</span>, <span class="fl">50.0</span>));</span>
<span id="cb48-30"><a href="#cb48-30"></a></span>
<span id="cb48-31"><a href="#cb48-31"></a>  <span class="co">// Border.</span></span>
<span id="cb48-32"><a href="#cb48-32"></a>  <span class="at">const</span> <span class="kw">auto</span> borderColor = CColor(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">255</span>);</span>
<span id="cb48-33"><a href="#cb48-33"></a>  pContext-&gt;setFrameColor(borderColor);</span>
<span id="cb48-34"><a href="#cb48-34"></a>  pContext-&gt;drawRect(</span>
<span id="cb48-35"><a href="#cb48-35"></a>    CRect(</span>
<span id="cb48-36"><a href="#cb48-36"></a>      halfBorderWidth,</span>
<span id="cb48-37"><a href="#cb48-37"></a>      halfBorderWidth,</span>
<span id="cb48-38"><a href="#cb48-38"></a>      width - halfBorderWidth,</span>
<span id="cb48-39"><a href="#cb48-39"></a>      height - halfBorderWidth),</span>
<span id="cb48-40"><a href="#cb48-40"></a>    kDrawStroked);</span>
<span id="cb48-41"><a href="#cb48-41"></a></span>
<span id="cb48-42"><a href="#cb48-42"></a>  setDirty(<span class="kw">false</span>);</span>
<span id="cb48-43"><a href="#cb48-43"></a>}</span>
<span id="cb48-44"><a href="#cb48-44"></a></span>
<span id="cb48-45"><a href="#cb48-45"></a>} <span class="co">// namespace Vst</span></span>
<span id="cb48-46"><a href="#cb48-46"></a>} <span class="co">// namespace Steinberg</span></span></code></pre></div>
<p><code>SomeFX/CMakeLists.txt</code> にファイルを追加します。</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span id="cb49-1"><a href="#cb49-1"></a><span class="kw">set</span>(plug_sources</span>
<span id="cb49-2"><a href="#cb49-2"></a>    //...</span>
<span id="cb49-3"><a href="#cb49-3"></a>    source/gui/splash.hpp <span class="co"># 追加</span></span>
<span id="cb49-4"><a href="#cb49-4"></a>    source/gui/splash.cpp <span class="co"># 追加</span></span>
<span id="cb49-5"><a href="#cb49-5"></a>)</span></code></pre></div>
<h4 id="ホストが提供するコンテキストメニューの追加">ホストが提供するコンテキストメニューの追加</h4>
<p>エディタクラスに <code>IMouseObserver</code> を継承させます。</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb50-1"><a href="#cb50-1"></a><span class="kw">class</span> PlugEditor : <span class="kw">public</span> VSTGUIEditor, <span class="kw">public</span> IControlListener, <span class="kw">public</span> IMouseObserver {</span>
<span id="cb50-2"><a href="#cb50-2"></a><span class="co">// ...</span></span>
<span id="cb50-3"><a href="#cb50-3"></a></span>
<span id="cb50-4"><a href="#cb50-4"></a>  <span class="co">// IMouseObserver の実装。</span></span>
<span id="cb50-5"><a href="#cb50-5"></a>  <span class="dt">void</span> onMouseEntered(CView *view, CFrame *frame) <span class="kw">override</span> {}</span>
<span id="cb50-6"><a href="#cb50-6"></a>  <span class="dt">void</span> onMouseExited(CView *view, CFrame *frame) <span class="kw">override</span> {}</span>
<span id="cb50-7"><a href="#cb50-7"></a>  CMouseEventResult</span>
<span id="cb50-8"><a href="#cb50-8"></a>  onMouseMoved(CFrame *frame, <span class="at">const</span> CPoint &amp;where, <span class="at">const</span> CButtonState &amp;buttons) <span class="kw">override</span></span>
<span id="cb50-9"><a href="#cb50-9"></a>  {</span>
<span id="cb50-10"><a href="#cb50-10"></a>    <span class="cf">return</span> kMouseEventNotHandled;</span>
<span id="cb50-11"><a href="#cb50-11"></a>  }</span>
<span id="cb50-12"><a href="#cb50-12"></a>  CMouseEventResult</span>
<span id="cb50-13"><a href="#cb50-13"></a>  onMouseDown(CFrame *frame, <span class="at">const</span> CPoint &amp;where, <span class="at">const</span> CButtonState &amp;buttons) <span class="kw">override</span>;</span>
<span id="cb50-14"><a href="#cb50-14"></a></span>
<span id="cb50-15"><a href="#cb50-15"></a><span class="co">// ...</span></span>
<span id="cb50-16"><a href="#cb50-16"></a>};</span></code></pre></div>
<p>エディタクラスの <code>open</code> メソッド内で <code>frame</code> からマウスイベントを伝えるように指定します。</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb51-1"><a href="#cb51-1"></a><span class="dt">bool</span> PlugEditor::open(<span class="dt">void</span> *parent, <span class="at">const</span> PlatformType &amp;platformType)</span>
<span id="cb51-2"><a href="#cb51-2"></a>{</span>
<span id="cb51-3"><a href="#cb51-3"></a>  <span class="co">// ...</span></span>
<span id="cb51-4"><a href="#cb51-4"></a></span>
<span id="cb51-5"><a href="#cb51-5"></a>  frame-&gt;registerMouseObserver(<span class="kw">this</span>);</span>
<span id="cb51-6"><a href="#cb51-6"></a></span>
<span id="cb51-7"><a href="#cb51-7"></a>  <span class="co">// ...</span></span>
<span id="cb51-8"><a href="#cb51-8"></a>}</span></code></pre></div>
<p><code>onMouseDown</code> を実装します。</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb52-1"><a href="#cb52-1"></a>CMouseEventResult</span>
<span id="cb52-2"><a href="#cb52-2"></a>PlugEditor::onMouseDown(CFrame *frame, <span class="at">const</span> CPoint &amp;where, <span class="at">const</span> CButtonState &amp;buttons)</span>
<span id="cb52-3"><a href="#cb52-3"></a>{</span>
<span id="cb52-4"><a href="#cb52-4"></a>  <span class="cf">if</span> (!buttons.isRightButton()) <span class="cf">return</span> kMouseEventNotHandled;</span>
<span id="cb52-5"><a href="#cb52-5"></a></span>
<span id="cb52-6"><a href="#cb52-6"></a>  <span class="kw">auto</span> componentHandler = controller-&gt;getComponentHandler();</span>
<span id="cb52-7"><a href="#cb52-7"></a>  <span class="cf">if</span> (componentHandler == <span class="kw">nullptr</span>) <span class="cf">return</span> kMouseEventNotHandled;</span>
<span id="cb52-8"><a href="#cb52-8"></a></span>
<span id="cb52-9"><a href="#cb52-9"></a>  FUnknownPtr&lt;IComponentHandler3&gt; handler(componentHandler);</span>
<span id="cb52-10"><a href="#cb52-10"></a>  <span class="cf">if</span> (handler == <span class="kw">nullptr</span>) <span class="cf">return</span> kMouseEventNotHandled;</span>
<span id="cb52-11"><a href="#cb52-11"></a></span>
<span id="cb52-12"><a href="#cb52-12"></a>  <span class="kw">auto</span> control = <span class="kw">dynamic_cast</span>&lt;CControl *&gt;(frame-&gt;getViewAt(where));</span>
<span id="cb52-13"><a href="#cb52-13"></a>  <span class="cf">if</span> (control == <span class="kw">nullptr</span>) <span class="cf">return</span> kMouseEventNotHandled;</span>
<span id="cb52-14"><a href="#cb52-14"></a></span>
<span id="cb52-15"><a href="#cb52-15"></a>  ParamID id = control-&gt;getTag();</span>
<span id="cb52-16"><a href="#cb52-16"></a>  <span class="cf">if</span> (id &lt; <span class="dv">1</span> || id &gt;= LONG_MAX) <span class="cf">return</span> kMouseEventNotHandled;</span>
<span id="cb52-17"><a href="#cb52-17"></a></span>
<span id="cb52-18"><a href="#cb52-18"></a>  IContextMenu *menu = handler-&gt;createContextMenu(<span class="kw">this</span>, &amp;id);</span>
<span id="cb52-19"><a href="#cb52-19"></a>  <span class="cf">if</span> (menu == <span class="kw">nullptr</span>) <span class="cf">return</span> kMouseEventNotHandled;</span>
<span id="cb52-20"><a href="#cb52-20"></a>  menu-&gt;popup(where.x, where.y);</span>
<span id="cb52-21"><a href="#cb52-21"></a>  menu-&gt;release();</span>
<span id="cb52-22"><a href="#cb52-22"></a>  <span class="cf">return</span> kMouseEventHandled;</span>
<span id="cb52-23"><a href="#cb52-23"></a>}</span></code></pre></div>
<p>0 あるいは負の tag が指定されたコントロールではコンテキストメニューを表示したくないので、 <code>id</code> の条件を <code>id &lt; 1 || id &gt;= LONG_MAX</code> としています。 <code>LONG_MAX</code> を使っているのは <code>ParamID</code> が <code>unsigned long</code> の typedef だからです。</p>
<p>コンテキストメニューが開かないときは <code>kMouseEventNotHandled</code> を返して、他のコントロールにマウスイベントが伝わるようにしています。</p>
<h4 id="コンテキストメニューにズーム機能を追加">コンテキストメニューにズーム機能を追加</h4>
<p>この項の内容は実装をあきらめたので中途半端です。次の問題が解決されていないので注意してください。</p>
<ul>
<li>コンテキストメニューはコントロールの上でしか表示されない。</li>
<li>入れ子になったメニューの登録がうまくできない。</li>
</ul>
<p>FL Studio 20.5 でズーム後にプラグインのウィンドウがリサイズされなかったことが、あきらめた理由です。</p>
<hr />
<p>ズーム機能は GUI を任意の倍率で拡大する機能です。 VSTGUI4 で高解像度ディスプレイへ対応するときに使えます。</p>
<p>まずはエディタクラスに <code>CommandMenuItemTargetAdapter</code> を継承させて、ユーザがコンテキストメニューのアイテムを選択したときに通知されるようにします。</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb53-1"><a href="#cb53-1"></a><span class="kw">class</span> PlugEditor : <span class="kw">public</span> VSTGUIEditor,</span>
<span id="cb53-2"><a href="#cb53-2"></a>                   <span class="kw">public</span> IControlListener,</span>
<span id="cb53-3"><a href="#cb53-3"></a>                   <span class="kw">public</span> IMouseObserver,</span>
<span id="cb53-4"><a href="#cb53-4"></a>                   <span class="kw">public</span> CommandMenuItemTargetAdapter {</span>
<span id="cb53-5"><a href="#cb53-5"></a><span class="co">// ...</span></span>
<span id="cb53-6"><a href="#cb53-6"></a></span>
<span id="cb53-7"><a href="#cb53-7"></a>  <span class="co">// CommandMenuItemTargetAdapter の実装。</span></span>
<span id="cb53-8"><a href="#cb53-8"></a>  <span class="dt">bool</span> validateCommandMenuItem(CCommandMenuItem *item) <span class="kw">override</span></span>
<span id="cb53-9"><a href="#cb53-9"></a>  {</span>
<span id="cb53-10"><a href="#cb53-10"></a>    <span class="cf">return</span> <span class="kw">false</span>;</span>
<span id="cb53-11"><a href="#cb53-11"></a>  };</span>
<span id="cb53-12"><a href="#cb53-12"></a>  <span class="dt">bool</span> onCommandMenuItemSelected(CCommandMenuItem *item) <span class="kw">override</span>;</span>
<span id="cb53-13"><a href="#cb53-13"></a></span>
<span id="cb53-14"><a href="#cb53-14"></a><span class="co">// ...</span></span>
<span id="cb53-15"><a href="#cb53-15"></a>};</span></code></pre></div>
<p><code>onCommandMenuItemSelected</code> の実装です。 2 つのメニューアイテムを用意して、 1.0 倍と 2.0 倍を切り替えられるようにしています。倍率の切り替えには <code>CFrame</code> の <code>setZoom</code> を使います。</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb54-1"><a href="#cb54-1"></a><span class="dt">bool</span> PlugEditor::onCommandMenuItemSelected(CCommandMenuItem *item)</span>
<span id="cb54-2"><a href="#cb54-2"></a>{</span>
<span id="cb54-3"><a href="#cb54-3"></a>  <span class="cf">if</span> (item-&gt;getCommandCategory() != <span class="st">&quot;Scale&quot;</span>) <span class="cf">return</span> <span class="kw">false</span>;</span>
<span id="cb54-4"><a href="#cb54-4"></a>  <span class="cf">if</span> (frame == <span class="kw">nullptr</span>) <span class="cf">return</span> <span class="kw">true</span>;</span>
<span id="cb54-5"><a href="#cb54-5"></a></span>
<span id="cb54-6"><a href="#cb54-6"></a>  <span class="cf">switch</span> (item-&gt;getTag()) {</span>
<span id="cb54-7"><a href="#cb54-7"></a>    <span class="cf">case</span> <span class="dv">0</span>: {</span>
<span id="cb54-8"><a href="#cb54-8"></a>      frame-&gt;setZoom(<span class="fl">1.0</span>);</span>
<span id="cb54-9"><a href="#cb54-9"></a>    } <span class="cf">break</span>;</span>
<span id="cb54-10"><a href="#cb54-10"></a></span>
<span id="cb54-11"><a href="#cb54-11"></a>    <span class="cf">case</span> <span class="dv">1</span>: {</span>
<span id="cb54-12"><a href="#cb54-12"></a>      frame-&gt;setZoom(<span class="fl">2.0</span>);</span>
<span id="cb54-13"><a href="#cb54-13"></a>    } <span class="cf">break</span>;</span>
<span id="cb54-14"><a href="#cb54-14"></a>  }</span>
<span id="cb54-15"><a href="#cb54-15"></a></span>
<span id="cb54-16"><a href="#cb54-16"></a>  <span class="cf">return</span> <span class="kw">true</span>;</span>
<span id="cb54-17"><a href="#cb54-17"></a>}</span></code></pre></div>
<p><code>onMouseDown</code> を変更してマウスが右クリックされたときに表示されるコンテキストメニューにズームを行うアイテムを追加します。</p>
<p>アイテムが選択されると <code>ContextMenuTarget</code> の <code>executeMenuItem</code> が呼び出されます。さらに <code>item-&gt;execute()</code> から <code>CommandMenuItemTargetAdapter</code> の <code>onCommandMenuItemSelected</code> が呼び出されます。</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb55-1"><a href="#cb55-1"></a><span class="kw">class</span> ContextMenuTarget : <span class="kw">public</span> IContextMenuTarget, <span class="kw">public</span> FObject {</span>
<span id="cb55-2"><a href="#cb55-2"></a><span class="kw">public</span>:</span>
<span id="cb55-3"><a href="#cb55-3"></a>  ContextMenuTarget(CCommandMenuItem *item) : item(item)</span>
<span id="cb55-4"><a href="#cb55-4"></a>  {</span>
<span id="cb55-5"><a href="#cb55-5"></a>    item-&gt;remember();</span>
<span id="cb55-6"><a href="#cb55-6"></a>  }</span>
<span id="cb55-7"><a href="#cb55-7"></a></span>
<span id="cb55-8"><a href="#cb55-8"></a>  ~ContextMenuTarget() <span class="kw">override</span></span>
<span id="cb55-9"><a href="#cb55-9"></a>  {</span>
<span id="cb55-10"><a href="#cb55-10"></a>    item-&gt;forget();</span>
<span id="cb55-11"><a href="#cb55-11"></a>  }</span>
<span id="cb55-12"><a href="#cb55-12"></a></span>
<span id="cb55-13"><a href="#cb55-13"></a>  Steinberg::tresult PLUGIN_API executeMenuItem(Steinberg::int32 tag) <span class="kw">override</span></span>
<span id="cb55-14"><a href="#cb55-14"></a>  {</span>
<span id="cb55-15"><a href="#cb55-15"></a>    item-&gt;execute();</span>
<span id="cb55-16"><a href="#cb55-16"></a>    <span class="cf">return</span> Steinberg::kResultTrue;</span>
<span id="cb55-17"><a href="#cb55-17"></a>  }</span>
<span id="cb55-18"><a href="#cb55-18"></a></span>
<span id="cb55-19"><a href="#cb55-19"></a>  OBJ_METHODS(ContextMenuTarget, Steinberg::FObject)</span>
<span id="cb55-20"><a href="#cb55-20"></a>  FUNKNOWN_METHODS(Steinberg::Vst::IContextMenuTarget, Steinberg::FObject)</span>
<span id="cb55-21"><a href="#cb55-21"></a><span class="kw">protected</span>:</span>
<span id="cb55-22"><a href="#cb55-22"></a>  CCommandMenuItem *item;</span>
<span id="cb55-23"><a href="#cb55-23"></a>};</span>
<span id="cb55-24"><a href="#cb55-24"></a></span>
<span id="cb55-25"><a href="#cb55-25"></a>CMouseEventResult</span>
<span id="cb55-26"><a href="#cb55-26"></a>PlugEditor::onMouseDown(CFrame *frame, <span class="at">const</span> CPoint &amp;where, <span class="at">const</span> CButtonState &amp;buttons)</span>
<span id="cb55-27"><a href="#cb55-27"></a>{</span>
<span id="cb55-28"><a href="#cb55-28"></a>  <span class="cf">if</span> (!buttons.isRightButton()) <span class="cf">return</span> kMouseEventNotHandled;</span>
<span id="cb55-29"><a href="#cb55-29"></a></span>
<span id="cb55-30"><a href="#cb55-30"></a>  <span class="kw">auto</span> componentHandler = controller-&gt;getComponentHandler();</span>
<span id="cb55-31"><a href="#cb55-31"></a>  <span class="cf">if</span> (componentHandler == <span class="kw">nullptr</span>) <span class="cf">return</span> kMouseEventNotHandled;</span>
<span id="cb55-32"><a href="#cb55-32"></a></span>
<span id="cb55-33"><a href="#cb55-33"></a>  FUnknownPtr&lt;IComponentHandler3&gt; handler(componentHandler);</span>
<span id="cb55-34"><a href="#cb55-34"></a>  <span class="cf">if</span> (handler == <span class="kw">nullptr</span>) <span class="cf">return</span> kMouseEventNotHandled;</span>
<span id="cb55-35"><a href="#cb55-35"></a></span>
<span id="cb55-36"><a href="#cb55-36"></a>  <span class="kw">auto</span> control = <span class="kw">dynamic_cast</span>&lt;CControl *&gt;(frame-&gt;getViewAt(where));</span>
<span id="cb55-37"><a href="#cb55-37"></a>  <span class="cf">if</span> (control == <span class="kw">nullptr</span>) <span class="cf">return</span> kMouseEventNotHandled;</span>
<span id="cb55-38"><a href="#cb55-38"></a></span>
<span id="cb55-39"><a href="#cb55-39"></a>  ParamID id = control-&gt;getTag();</span>
<span id="cb55-40"><a href="#cb55-40"></a>  <span class="cf">if</span> (id &lt; <span class="dv">1</span> || id &gt;= LONG_MAX) <span class="cf">return</span> kMouseEventNotHandled;</span>
<span id="cb55-41"><a href="#cb55-41"></a></span>
<span id="cb55-42"><a href="#cb55-42"></a>  <span class="kw">auto</span> contextMenu = handler-&gt;createContextMenu(<span class="kw">this</span>, &amp;id);</span>
<span id="cb55-43"><a href="#cb55-43"></a>  <span class="cf">if</span> (contextMenu == <span class="kw">nullptr</span>) <span class="cf">return</span> kMouseEventNotHandled;</span>
<span id="cb55-44"><a href="#cb55-44"></a></span>
<span id="cb55-45"><a href="#cb55-45"></a>  <span class="co">// ここからメニューの追加。</span></span>
<span id="cb55-46"><a href="#cb55-46"></a></span>
<span id="cb55-47"><a href="#cb55-47"></a>  <span class="co">// kIsGroupStart を設定してもメニューが入れ子にならない。</span></span>
<span id="cb55-48"><a href="#cb55-48"></a>  IContextMenu::Item groupItem{};</span>
<span id="cb55-49"><a href="#cb55-49"></a>  UString128(<span class="st">&quot;Scale&quot;</span>).copyTo(groupItem.name, <span class="dv">128</span>);</span>
<span id="cb55-50"><a href="#cb55-50"></a>  groupItem.flags = IContextMenu::Item::kIsGroupStart;</span>
<span id="cb55-51"><a href="#cb55-51"></a>  contextMenu-&gt;addItem(groupItem, <span class="kw">nullptr</span>);</span>
<span id="cb55-52"><a href="#cb55-52"></a></span>
<span id="cb55-53"><a href="#cb55-53"></a>  <span class="bu">std::</span>array&lt;<span class="dt">double</span>, <span class="dv">2</span>&gt; scales = {<span class="fl">1.0</span>, <span class="fl">2.0</span>};</span>
<span id="cb55-54"><a href="#cb55-54"></a>  <span class="cf">for</span> (<span class="dt">size_t</span> index = <span class="dv">0</span>; index &lt; scales.size(); ++index) {</span>
<span id="cb55-55"><a href="#cb55-55"></a>    IContextMenu::Item item{};</span>
<span id="cb55-56"><a href="#cb55-56"></a>    UString128(<span class="bu">std::</span>to_string(scales[index]).c_str()).copyTo(item.name, <span class="dv">128</span>);</span>
<span id="cb55-57"><a href="#cb55-57"></a>    item.flags = <span class="dv">0</span>;</span>
<span id="cb55-58"><a href="#cb55-58"></a>    item.tag = (<span class="dt">int32_t</span>)index;</span>
<span id="cb55-59"><a href="#cb55-59"></a></span>
<span id="cb55-60"><a href="#cb55-60"></a>    <span class="co">// 注意: VSTGUI 4.8 では CCommandMenuItem::Desc に渡した tag が</span></span>
<span id="cb55-61"><a href="#cb55-61"></a>    <span class="co">// CCommandMenuItem に渡されずに無視される。</span></span>
<span id="cb55-62"><a href="#cb55-62"></a>    <span class="kw">auto</span> command = <span class="kw">new</span> CCommandMenuItem({<span class="kw">nullptr</span>, item.tag, <span class="kw">this</span>, <span class="st">&quot;Scale&quot;</span>, <span class="kw">nullptr</span>});</span>
<span id="cb55-63"><a href="#cb55-63"></a>    command-&gt;setTag(item.tag);</span>
<span id="cb55-64"><a href="#cb55-64"></a>    contextMenu-&gt;addItem(item, <span class="kw">new</span> ContextMenuTarget(command));</span>
<span id="cb55-65"><a href="#cb55-65"></a>  }</span>
<span id="cb55-66"><a href="#cb55-66"></a></span>
<span id="cb55-67"><a href="#cb55-67"></a>  <span class="co">// kIsGroupEnd を設定してもメニューが入れ子にならない。</span></span>
<span id="cb55-68"><a href="#cb55-68"></a>  groupItem.flags = IContextMenu::Item::kIsGroupEnd;</span>
<span id="cb55-69"><a href="#cb55-69"></a>  contextMenu-&gt;addItem(groupItem, <span class="kw">nullptr</span>);</span>
<span id="cb55-70"><a href="#cb55-70"></a></span>
<span id="cb55-71"><a href="#cb55-71"></a>  <span class="co">// ここまでメニューの追加。</span></span>
<span id="cb55-72"><a href="#cb55-72"></a></span>
<span id="cb55-73"><a href="#cb55-73"></a>  contextMenu-&gt;popup(where.x, where.y);</span>
<span id="cb55-74"><a href="#cb55-74"></a>  contextMenu-&gt;release();</span>
<span id="cb55-75"><a href="#cb55-75"></a>  <span class="cf">return</span> kMouseEventHandled;</span>
<span id="cb55-76"><a href="#cb55-76"></a>}</span></code></pre></div>
<p>コメントにも書いていますが、 <code>kIsGroupStart</code> と <code>kIsGroupEnd</code> を設定してもメニューが入れ子になりません。</p>
<p>どこを右クリックしてもメニューが開くようにするには <code>COptionMenu</code> でメニューを作っておいて、コントロール上で右クリックされているときは <code>IContextMenu</code> に変換する、そうでなければ <code>COptionMenu</code> をそのままポップアップする、という処理が考えられます。 <code>vstgui4/vstgui/plugin-bindings/vst3editor.*</code> に実装例があります。</p>
</body>

</html>
